name: Update Section Semantic (LLM)

"on":
  workflow_dispatch:
    inputs:
      max_sections:
        description: "Limit number of sections to update (optional)"
        required: false
        default: ""
      concurrency:
<<<<<<< HEAD
        description: "LLM request concurrency (higher = faster, may trigger 429)"
        required: false
        default: "1"
      max_runtime_minutes:
        description: "Stop LLM generation after N minutes (checkpoint will be committed to PR)"
        required: false
        default: "120"
=======
        description: "LLM request concurrency (optional, empty = script default)"
        required: false
        default: ""
>>>>>>> add-new-text

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Warning (no concurrency limit)
        run: |
          echo "::warning::This workflow no longer limits concurrent runs. Make sure you understand the cost/quotas of your LLM provider. Use workflow inputs (max_sections / concurrency) to control spend and load."

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Verify secrets
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
        run: |
          if [ -z "${LLM_API_KEY}" ]; then
            echo "Missing secrets.LLM_API_KEY"
            exit 1
          fi
          if [ -z "${LLM_BASE_URL}" ]; then
            echo "Missing secrets.LLM_BASE_URL"
            exit 1
          fi

      - name: Restore checkpoint from PR branch (if exists)
        run: |
          set -euo pipefail
          BRANCH="chore/update-section-semantic-llm"
          FILE="docs/search/section-semantic.ai.v1.json.gz"

          if git fetch --no-tags --depth=1 origin "${BRANCH}"; then
            if git cat-file -e "FETCH_HEAD:${FILE}" 2>/dev/null; then
              mkdir -p "$(dirname "${FILE}")"
              git show "FETCH_HEAD:${FILE}" > "${FILE}"
              echo "Restored checkpoint: ${FILE} (from ${BRANCH})"
            else
              echo "No checkpoint file found on ${BRANCH}; start fresh."
            fi
          else
            echo "No existing branch ${BRANCH}; start fresh."
          fi

      - name: Generate section semantic YAML
        id: generate_semantic
        continue-on-error: true
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
          LLM_MODEL: ${{ secrets.LLM_MODEL }}
          MAX_SECTIONS: ${{ github.event.inputs.max_sections }}
          CONCURRENCY: ${{ github.event.inputs.concurrency }}
<<<<<<< HEAD
          MAX_RUNTIME_MINUTES: ${{ github.event.inputs.max_runtime_minutes }}
          FLUSH_EVERY: "1"
=======
>>>>>>> add-new-text
        run: |
          if [ -z "${LLM_MODEL}" ]; then
            export LLM_MODEL="glm-4.7-flash"
          fi
          node scripts/generate-section-semantic.js

      - name: Build indices
        if: always()
        continue-on-error: true
        run: |
          npm run build

      - name: Create Pull Request
        if: always()
        uses: peter-evans/create-pull-request@v6
        with:
          # If your repo/org disables PR creation for GITHUB_TOKEN, set a PAT in secrets.CREATE_PR_TOKEN.
          token: ${{ secrets.CREATE_PR_TOKEN || github.token }}
          commit-message: "chore: update section semantic (LLM)"
          title: "chore: update section semantic (LLM)"
          body: |
            Automated update of per-section semantic metadata and regenerated search indices.

            - Updated: `docs/search/section-semantic.ai.v1.json.gz`
            - Regenerated: `assets/semantic/*`, `assets/search-index.json`, `docs/config.json`, `sitemap.xml`
          branch: "chore/update-section-semantic-llm"
          delete-branch: true
