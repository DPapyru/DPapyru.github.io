(function(){"use strict";const d=Object.freeze({INDEX_SET:"index.set",INDEX_SET_RESPONSE:"index.set.response",COMPLETION_REQUEST:"completion.request",COMPLETION_RESPONSE:"completion.response",HOVER_REQUEST:"hover.request",HOVER_RESPONSE:"hover.response",DIAGNOSTICS_RULE_REQUEST:"diagnostics.rule.request",DIAGNOSTICS_RULE_RESPONSE:"diagnostics.rule.response",DIAGNOSTICS_ROSLYN_REQUEST:"diagnostics.roslyn.request",DIAGNOSTICS_ROSLYN_RESPONSE:"diagnostics.roslyn.response",ASSEMBLY_IMPORT_REQUEST:"assembly.import.request",ASSEMBLY_IMPORT_RESPONSE:"assembly.import.response",ERROR:"error"}),S=Object.freeze({INFO:"info",WARNING:"warning",ERROR:"error"});function H(e){const t=String(e||"").trim(),r=t.lastIndexOf("."),s=r>0?t.slice(0,r):"",n=r>0?t.slice(r+1):t;return{fullName:t,namespace:s,name:n,summary:"",members:{methods:[],properties:[],fields:[]}}}function z(e){(!e.members||typeof e.members!="object")&&(e.members={methods:[],properties:[],fields:[]}),Array.isArray(e.members.methods)||(e.members.methods=[]),Array.isArray(e.members.properties)||(e.members.properties=[]),Array.isArray(e.members.fields)||(e.members.fields=[])}function K(e){const t=Array.isArray(e.params)?e.params.map(n=>({name:String(n&&n.name||""),type:String(n&&n.type||"object"),optional:!!(n&&n.optional),defaultValue:n&&Object.prototype.hasOwnProperty.call(n,"defaultValue")?n.defaultValue:null})):[];let r=Number.isFinite(Number(e.minArgs))?Number(e.minArgs):0,s=Number.isFinite(Number(e.maxArgs))?Number(e.maxArgs):t.length;return r<0&&(r=0),s<r&&(s=r),{kind:"method",name:String(e.name||""),signature:String(e.signature||""),returnType:String(e.returnType||"void"),isStatic:!!e.isStatic,params:t,minArgs:r,maxArgs:s,summary:String(e.summary||""),returnsDoc:String(e.returnsDoc||""),paramDocs:e.paramDocs&&typeof e.paramDocs=="object"?e.paramDocs:{}}}function q(e){return{kind:"property",name:String(e.name||""),signature:String(e.signature||""),type:String(e.type||"object"),isStatic:!!e.isStatic,summary:String(e.summary||"")}}function J(e){return{kind:"field",name:String(e.name||""),signature:String(e.signature||""),type:String(e.type||"object"),isStatic:!!e.isStatic,summary:String(e.summary||"")}}function w(){return{schemaVersion:2,generatedAt:new Date().toISOString(),sources:[],types:{},lookup:{byShortName:{},namespaces:[]}}}function L(e){const t={},r=new Set;return Object.keys(e.types).forEach(s=>{const n=e.types[s],o=String(n.name||"").trim();o&&(Array.isArray(t[o])||(t[o]=[]),t[o].push(s),n.namespace&&r.add(n.namespace))}),Object.keys(t).forEach(s=>{t[s].sort((n,o)=>n.localeCompare(o))}),e.lookup={byShortName:t,namespaces:Array.from(r).sort((s,n)=>s.localeCompare(n))},e.lookup}function b(e){const t=w();if(!e||typeof e!="object")return t;t.generatedAt=String(e.generatedAt||t.generatedAt),Array.isArray(e.sources)&&(t.sources=e.sources.map(s=>({assemblyName:String(s&&s.assemblyName||""),dllPath:String(s&&s.dllPath||""),xmlPath:String(s&&s.xmlPath||"")})));const r=e.types&&typeof e.types=="object"?e.types:{};return Object.keys(r).forEach(s=>{const n=r[s],o=H(s);o.namespace=String(n&&n.namespace||o.namespace),o.name=String(n&&n.name||o.name),o.summary=String(n&&n.summary||""),z(o);const c=n&&n.members&&typeof n.members=="object"?n.members:{},i=Array.isArray(c.methods)?c.methods:[],l=Array.isArray(c.properties)?c.properties:[],a=Array.isArray(c.fields)?c.fields:[];o.members.methods=i.map(K).filter(m=>!!m.name).sort((m,u)=>{const f=m.name.localeCompare(u.name);if(f!==0)return f;const g=m.minArgs-u.minArgs;return g!==0?g:m.signature.localeCompare(u.signature)}),o.members.properties=l.map(q).filter(m=>!!m.name).sort((m,u)=>m.name.localeCompare(u.name)),o.members.fields=a.map(J).filter(m=>!!m.name).sort((m,u)=>m.name.localeCompare(u.name)),t.types[s]=o}),L(t),t}function Z(e){return`${e.kind}:${e.name}:${e.signature}`}function ee(e,t){const r=b(e),s=b(t);return s.sources.forEach(n=>{r.sources.some(c=>c.assemblyName===n.assemblyName&&c.dllPath===n.dllPath)||r.sources.push(n)}),Object.keys(s.types).forEach(n=>{const o=s.types[n];if(!r.types[n]){r.types[n]=o;return}const c=r.types[n];z(c),!c.summary&&o.summary&&(c.summary=o.summary);const i=l=>{const a=new Map;c.members[l].forEach(m=>{a.set(Z(m),m)}),o.members[l].forEach(m=>{const u=Z(m);if(!a.has(u)){a.set(u,m);return}!a.get(u).summary&&m.summary&&a.set(u,m)}),c.members[l]=Array.from(a.values()).sort((m,u)=>{const f=m.name.localeCompare(u.name);return f!==0?f:m.signature.localeCompare(u.signature)})};i("methods"),i("properties"),i("fields")}),L(r),r}function $(e,t){const r=String(t||"").trim();return r&&e.types[r]||null}function te(e,t){const r=String(t||"").trim();if(!r)return[];const s=e.lookup&&e.lookup.byShortName?e.lookup.byShortName:{};return(Array.isArray(s[r])?s[r]:[]).map(o=>$(e,o)).filter(Boolean)}const j=["using","namespace","class","struct","interface","enum","record","public","private","protected","internal","static","virtual","override","abstract","void","bool","byte","sbyte","short","ushort","int","uint","long","ulong","float","double","decimal","string","object","if","else","switch","case","for","foreach","while","do","break","continue","return","new","try","catch","finally","throw","var","this","base","true","false","null","params","out","ref","in","async","await","partial","sealed","readonly","const","get","set","init"],re=new Set(["void","bool","byte","sbyte","short","ushort","int","uint","long","ulong","float","double","decimal","string","object","char"]);function N(e){let t=String(e||"").trim();t=t.replace(/\[\]$/g,"");const r=t.indexOf("<");return r>=0&&(t=t.slice(0,r)),t}function C(e){const t=String(e||""),r=new Set,s=new Set,n=new Map;let o;const c=/^\s*using\s+([A-Za-z_][A-Za-z0-9_.]*)\s*;/gm;for(;(o=c.exec(t))!==null;)r.add(o[1]);const i=/\b(?:class|struct|interface|enum|record)\s+([A-Za-z_][A-Za-z0-9_]*)/g;for(;(o=i.exec(t))!==null;)s.add(o[1]);const l=/\b([A-Za-z_][A-Za-z0-9_<>\[\],.]*)\s+([a-zA-Z_][A-Za-z0-9_]*)\s*(?==|;|,|\))/g;for(;(o=l.exec(t))!==null;){const u=N(o[1]);!u||j.includes(u)||n.set(o[2],u)}const a=/\bvar\s+([a-zA-Z_][A-Za-z0-9_]*)\s*=\s*new\s+([A-Za-z_][A-Za-z0-9_<>\[\],.]*)/g;for(;(o=a.exec(t))!==null;)n.set(o[1],N(o[2]));const m=/\bforeach\s*\(\s*([A-Za-z_][A-Za-z0-9_<>\[\],.]*)\s+([a-zA-Z_][A-Za-z0-9_]*)\s+in\s+/g;for(;(o=m.exec(t))!==null;)n.set(o[2],N(o[1]));return{usings:r,declaredTypes:s,localTypes:n}}function R(e,t,r){const s=N(t);if(!s)return null;if(s.includes(".")){const i=$(e,s);if(i)return i}const n=te(e,s);if(!n.length)return null;const o=r&&r.usings instanceof Set?r.usings:new Set;return n.map(i=>{let l=10;return i.namespace&&o.has(i.namespace)&&(l=0),i.namespace==="Terraria"&&(l=Math.min(l,1)),i.namespace==="Terraria.ModLoader"&&(l=Math.min(l,2)),{candidate:i,score:l}}).sort((i,l)=>{const a=i.score-l.score;return a!==0?a:i.candidate.fullName.localeCompare(l.candidate.fullName)})[0].candidate}function P(e,t,r){const s=String(t||"").trim();return s?r.localTypes.has(s)?R(e,r.localTypes.get(s),r):/^[A-Z]/.test(s)||r.declaredTypes.has(s)?R(e,s,r):null:null}function U(e,t){const r=String(t||"").trim();if(!r||!e)return[];const s=[];return e.members.methods.forEach(n=>{n.name===r&&s.push(n)}),e.members.properties.forEach(n=>{n.name===r&&s.push(n)}),e.members.fields.forEach(n=>{n.name===r&&s.push(n)}),s}function ne(e,t){const r=String(t||"").toLowerCase(),s=[];return e.members.methods.forEach(n=>s.push(n)),e.members.properties.forEach(n=>s.push(n)),e.members.fields.forEach(n=>s.push(n)),s.filter(n=>n.name.toLowerCase().startsWith(r)).sort((n,o)=>{const c=n.name.localeCompare(o.name);return c!==0?c:String(n.signature||"").localeCompare(String(o.signature||""))})}function se(e,t){const r=String(e||""),s=Math.max(0,Math.min(r.length,Number(t)||0));let n=s;for(;n>0&&/[A-Za-z0-9_]/.test(r[n-1]);)n-=1;let o=s;for(;o<r.length&&/[A-Za-z0-9_]/.test(r[o]);)o+=1;return n===o?null:{token:r.slice(n,o),start:n,end:o}}function oe(e,t){const r=String(e||""),s=Math.max(0,Math.min(r.length,Number(t)||0)),o=r.slice(0,s).match(/([A-Za-z_][A-Za-z0-9_]*)\.([A-Za-z_][A-Za-z0-9_]*)?$/);return o?{objectName:o[1],memberPrefix:o[2]||""}:null}function ae(e){const t=String(e||"").trim();if(!t)return 0;let r=0,s=0,n=0,o=!1,c="",i=1;for(let l=0;l<t.length;l++){const a=t[l],m=l>0?t[l-1]:"";if(o){a===c&&m!=="\\"&&(o=!1,c="");continue}if(a==='"'||a==="'"){o=!0,c=a;continue}a==="("?r+=1:a===")"?r-=1:a==="["?s+=1:a==="]"?s-=1:a==="{"?n+=1:a==="}"?n-=1:a===","&&r===0&&s===0&&n===0&&(i+=1)}return Math.max(0,i)}function ie(e){const t=String(e||""),r=[0];for(let s=0;s<t.length;s++)t[s]===`
`&&r.push(s+1);return r}function v(e,t){let r=0,s=e.length-1,n=0;for(;r<=s;){const o=Math.floor((r+s)/2);e[o]<=t?(n=o,r=o+1):s=o-1}return{line:n+1,column:t-e[n]+1}}function E(e,t,r,s,n,o,c){const i=Math.max(0,Number(r)||0),l=Math.max(i+1,Number(s)||i+1),a=v(t,i),m=v(t,l);e.push({code:n,severity:o,message:c,startLineNumber:a.line,startColumn:a.column,endLineNumber:m.line,endColumn:m.column})}function I(e){return String(e||"").replace(/\s+/g," ").trim()}function ce(e){return String(e||"").replace(/\{.*\}/g,"").replace(/&/g,"").replace(/`[0-9]+/g,"").trim()}function M(e,t){if(!e.types[t]){const r=t.lastIndexOf("."),s=r>=0?t.slice(0,r):"",n=r>=0?t.slice(r+1):t;e.types[t]={fullName:t,namespace:s,name:n,summary:"",members:{methods:[],properties:[],fields:[]}}}return e.types[t]}function me(e){const t=String(e||"").trim(),r=t.indexOf(":");if(r<=0)return null;const s=t.slice(0,r),n=t.slice(r+1);return{prefix:s,value:n}}function k(e){const t=e.lastIndexOf(".");return t<=0?null:{declaringType:e.slice(0,t),memberName:e.slice(t+1)}}function le(e){const t=e.indexOf("("),r=e.lastIndexOf(")"),s=t>=0?e.slice(0,t):e,n=t>=0&&r>t?e.slice(t+1,r):"",o=k(s);if(!o)return null;const c=n?n.split(",").map(i=>ce(i)).filter(Boolean):[];return{declaringType:o.declaringType,memberName:o.memberName,params:c}}function W(e){const t=String(e||"").trim();if(!t)return"ImportedAssembly";const r=Math.max(t.lastIndexOf("/"),t.lastIndexOf("\\")),s=r>=0?t.slice(r+1):t;return(s.toLowerCase().endsWith(".dll")?s.slice(0,-4):s)||"ImportedAssembly"}function G(e){return String(e||"").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'")}function B(e,t){const r=new RegExp(`<${t}[^>]*>([\\s\\S]*?)<\\/${t}>`,"i"),s=String(e||"").match(r);return s?I(G(s[1])):""}function X(e){const t={},r=/<param\s+name=\"([^\"]+)\"[^>]*>([\s\S]*?)<\/param>/gi;let s;for(;(s=r.exec(String(e||"")))!==null;){const n=String(s[1]||"").trim(),o=I(G(s[2]));!n||!o||(t[n]=o)}return t}function ue(e){const t=String(e||"").trim();if(!t)return[];if(typeof DOMParser<"u"){const c=new DOMParser().parseFromString(t,"application/xml");if(c.querySelector("parsererror"))throw new Error("XML 文档格式错误，无法解析。");return Array.from(c.querySelectorAll("member")).map(i=>{const l=i.outerHTML||"";return{name:String(i.getAttribute("name")||"").trim(),summary:I((i.querySelector("summary")||{}).textContent||""),returnsDoc:I((i.querySelector("returns")||{}).textContent||""),paramDocs:X(l)}})}const r=[],s=/<member\s+name=\"([^\"]+)\"[^>]*>([\s\S]*?)<\/member>/gi;let n;for(;(n=s.exec(t))!==null;)r.push({name:String(n[1]||"").trim(),summary:B(n[2],"summary"),returnsDoc:B(n[2],"returns"),paramDocs:X(n[2])});return r}function fe(e,t){const r=String(e||"").trim();if(!r)throw new Error("XML 文档为空，无法导入程序集。");const s=w();return s.sources.push({assemblyName:W(t),dllPath:String(t||""),xmlPath:""}),ue(r).forEach(o=>{const c=String(o.name||"").trim();if(!c)return;const i=me(c);if(!i)return;const l=String(o.summary||"");if(i.prefix==="T"){const a=M(s,i.value);!a.summary&&l&&(a.summary=l);return}if(i.prefix==="M"){const a=le(i.value);if(!a)return;M(s,a.declaringType).members.methods.push({kind:"method",name:a.memberName,signature:`${a.memberName}(${a.params.join(", ")})`,returnType:"object",isStatic:!1,params:a.params.map((u,f)=>({name:`arg${f+1}`,type:u,optional:!1,defaultValue:null})),minArgs:a.params.length,maxArgs:a.params.length,summary:l,returnsDoc:String(o.returnsDoc||""),paramDocs:o.paramDocs&&typeof o.paramDocs=="object"?o.paramDocs:{}});return}if(i.prefix==="P"){const a=k(i.value);if(!a)return;M(s,a.declaringType).members.properties.push({kind:"property",name:a.memberName,signature:`${a.memberName} { get; set; }`,type:"object",isStatic:!1,summary:l});return}if(i.prefix==="F"){const a=k(i.value);if(!a)return;M(s,a.declaringType).members.fields.push({kind:"field",name:a.memberName,signature:a.memberName,type:"object",isStatic:!1,summary:l})}}),b(s)}function pe(e){return{index:b(e)}}function ge(e,t){return e.index=b(t),e.index}function he(e,t){const r=t&&t.dllName?t.dllName:"",s=t&&t.xmlText?t.xmlText:"",n=fe(s,r);return e.index=ee(e.index,n),{assemblyName:W(r),importedTypes:Object.keys(n.types).length,totalTypes:Object.keys(e.index.types).length}}function ye(e,t){const r=String(t&&t.text||""),s=Number(t&&t.offset||0),n=Math.max(10,Math.min(200,Number(t&&t.maxItems||60))),o=C(r),c=e.index,i=oe(r,s);if(i){const f=P(c,i.objectName,o);return f?ne(f,i.memberPrefix).slice(0,n).map(y=>({label:y.name,insertText:y.name,kind:y.kind,detail:y.signature||y.type||y.returnType||"",documentation:y.summary||"",sortText:`1_${y.name}`})):[]}const l=r.slice(0,s).match(/[A-Za-z_][A-Za-z0-9_]*$/),a=l?l[0].toLowerCase():"",m=Object.keys(c.lookup.byShortName||{}).filter(f=>a?f.toLowerCase().startsWith(a):!0).sort((f,g)=>f.localeCompare(g)).slice(0,n).map(f=>({label:f,insertText:f,kind:"class",detail:(c.lookup.byShortName[f]||[])[0]||"",documentation:"",sortText:`2_${f}`})),u=j.filter(f=>a?f.startsWith(a):!0).map(f=>({label:f,insertText:f,kind:"keyword",detail:"C# keyword",documentation:"",sortText:`3_${f}`}));return m.concat(u).slice(0,n)}function de(e,t){const r=String(t&&t.text||""),s=Number(t&&t.offset||0),n=e.index,o=C(r),c=se(r,s);if(!c)return null;const l=r.slice(0,c.start).match(/([A-Za-z_][A-Za-z0-9_]*)\.$/);if(l){const u=P(n,l[1],o);if(!u)return null;const f=U(u,c.token);if(!f.length)return null;const g=[],y=`${u.fullName}.${c.token}`;g.push(`**${y}**`);const p=f[0];return p.signature&&g.push("","`"+p.signature+"`"),p.summary&&g.push("",p.summary),f.length>1&&g.push("",`重载数: ${f.length}`),{startOffset:c.start,endOffset:c.end,markdown:g.join(`
`)}}const a=R(n,c.token,o);if(!a)return null;const m=[`**${a.fullName}**`];return a.summary&&m.push("",a.summary),m.push("",`Methods: ${a.members.methods.length} · Properties: ${a.members.properties.length} · Fields: ${a.members.fields.length}`),{startOffset:c.start,endOffset:c.end,markdown:m.join(`
`)}}function Se(e,t){const r=String(t&&t.text||""),s=e.index,n=ie(r),o=[],c=C(r),i=[],l={"(":")","{":"}","[":"]"},a={")":"(","}":"{","]":"["};for(let p=0;p<r.length;p++){const h=r[p];if(l[h]){i.push({ch:h,offset:p});continue}if(a[h]){const T=i.pop();(!T||T.ch!==a[h])&&E(o,n,p,p+1,"RULE_UNEXPECTED_CLOSING",S.ERROR,`意外的闭合符号 '${h}'`)}}i.forEach(p=>{E(o,n,p.offset,p.offset+1,"RULE_UNCLOSED_SYMBOL",S.ERROR,`符号 '${p.ch}' 未闭合`)});const m=r.split(/\r?\n/);let u=0;m.forEach(p=>{const h=p.trim();if(!h||h.startsWith("//")){u+=p.length+1;return}const T=/[=.]|\b(return|throw|await|new)\b/.test(h),_=h.endsWith(";")||h.endsWith("{")||h.endsWith("}")||h.endsWith(":")||h.startsWith("using ")||h.startsWith("namespace ")||h.startsWith("#")||/^\[/.test(h)||/^(if|for|foreach|while|switch|catch|else|try|do)\b/.test(h);if(T&&!_){const O=u+p.length;E(o,n,Math.max(u,O-1),Math.max(u+1,O),"RULE_MISSING_SEMICOLON",S.WARNING,"疑似缺少分号")}u+=p.length+1});const f=/\b([A-Z][A-Za-z0-9_]*(?:\[\])?)\s+[a-zA-Z_][A-Za-z0-9_]*\b/g;let g;for(;(g=f.exec(r))!==null;){const p=N(g[1]);if(!p||re.has(p)||c.declaredTypes.has(p))continue;R(s,p,c)||E(o,n,g.index,g.index+p.length,"RULE_UNKNOWN_TYPE",S.WARNING,`未识别的类型：${p}`)}const y=/\b([A-Za-z_][A-Za-z0-9_]*)\.([A-Za-z_][A-Za-z0-9_]*)\s*(\(([^)]*)\))?/g;for(;(g=y.exec(r))!==null;){const p=g[1],h=g[2],T=g[4]||"",_=P(s,p,c);if(!_)continue;const O=U(_,h);if(!O.length){E(o,n,g.index+p.length+1,g.index+p.length+1+h.length,"RULE_UNKNOWN_MEMBER",S.ERROR,`${_.name} 中不存在成员：${h}`);continue}if(g[3]){const D=ae(T),F=O.filter(V=>V.kind==="method");F.length&&(F.some(Q=>D>=Q.minArgs&&D<=Q.maxArgs)||E(o,n,g.index,g.index+g[0].length,"RULE_ARG_COUNT",S.WARNING,`${h}(...) 参数个数疑似不匹配，当前 ${D}`))}}return o}function Y(e){const t=b(e),r=Object.keys(t.types);let s=0,n=0,o=0;return r.forEach(c=>{const i=t.types[c];s+=i.members.methods.length,n+=i.members.properties.length,o+=i.members.fields.length}),{types:r.length,methods:s,properties:n,fields:o,sources:t.sources.length}}const A=pe(w());function x(e,t,r){self.postMessage({id:e,type:t,payload:r})}self.onmessage=function(e){const t=e&&e.data?e.data:{},r=t.id,s=t.type,n=t.payload||{};try{if(s===d.INDEX_SET){const o=ge(A,n.index);x(r,d.INDEX_SET_RESPONSE,{ok:!0,stats:Y(o)});return}if(s===d.COMPLETION_REQUEST){const o=ye(A,n);x(r,d.COMPLETION_RESPONSE,{items:o});return}if(s===d.HOVER_REQUEST){const o=de(A,n);x(r,d.HOVER_RESPONSE,{hover:o});return}if(s===d.DIAGNOSTICS_RULE_REQUEST){const o=Se(A,n);x(r,d.DIAGNOSTICS_RULE_RESPONSE,{diagnostics:o});return}if(s===d.ASSEMBLY_IMPORT_REQUEST){const o=he(A,n);x(r,d.ASSEMBLY_IMPORT_RESPONSE,{summary:o,stats:Y(A.index)});return}throw new Error(`Unsupported message type: ${String(s||"")}`)}catch(o){x(r,d.ERROR,{message:o&&o.message?o.message:String(o)})}}})();
