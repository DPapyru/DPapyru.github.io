---
title: 使用网页特殊动画模块
author: DPapyru
category: 怎么贡献
topic: article-contribution
last_updated: 2026-02-06
description: 用 C# 编写可视化动画，并在构建时编译为 JS 以供浏览器运行
difficulty: beginner
time: 10分钟
---

本文介绍站点的网页动画模块：用 C# 编写可视化动画（弹幕、NPC 对话、Boss/NPC 的 AI 分析动画、数学可视化等），在构建时编译成 JS，并在文章中以“特殊语法”嵌入到 `/site/pages/viewer.html`。

## 你会得到什么

- **文章内嵌动画**：Markdown 中用一行 `{{anim:anims/*.cs}}` 引用动画脚本。
- **C# 运行时 API**：`AnimContext` + `IAnimScript` + `ICanvas2D`（逐步扩展中）。
- **编译为 JS**：浏览器只运行 JS，不加载 WASM / dotnet runtime。
- **开发渲染器**：打开 `/site/pages/anim-renderer.html` 预览（注意：不支持浏览器内编译）。

## 目录

- 基本概念与目录结构
- 在 Markdown 中嵌入动画（`anim` 指令）
- 脚本结构：`IAnimScript`
- 开发预览：`/site/pages/anim-renderer.html`
- 常见问题与排错

## 基本概念与目录结构

动画相关的核心目录：

- 源码：`site/content/anims/**/*.cs`
- 构建产物：`site/assets/anims/**/*.js`
- 运行时：`site/assets/js/animcs-js-runtime.js`
- 清单：`site/assets/anims/manifest.json`

注意：

- 文章里写的是 **`.cs` 路径**（`anims/*.cs`），运行时会通过清单映射到 `.js`。
- 禁止在文章里写 URL 或跳出目录的路径（运行时会拒绝）。

## 快速开始（最短路径）

1. 在 `site/content/anims/` 下创建一个 `*.cs` 动画脚本（示例：`site/content/anims/demo-basic.cs`）。
2. 运行构建：`npm run build`（会生成 `site/assets/anims/*.js` 与清单）。
3. 在 Markdown 里用 `{{anim:...}}` 指令引入。

## `anim` 指令

在文章中插入下面这行：

```text
{{anim:anims/demo-basic.cs}}
```

渲染后会出现一个动画面板，并自动播放。

## 示例脚本

数学动画（坐标轴/向量/矩阵变换）：

```text
{{anim:anims/demo-math-transform.cs}}
```

NPC/Boss AI 动画（克苏鲁之眼风格行为）：

```text
{{anim:anims/demo-eoc-ai.cs}}
```

## 脚本结构：`IAnimScript`

每个动画脚本需要：

- 一个 `AnimEntry` 属性（入口名）
- 一个实现 `IAnimScript` 的类

```csharp
using AnimRuntime;
using AnimRuntime.Math;

[AnimEntry("demo-basic")]
public sealed class DemoBasic : IAnimScript
{
    public void OnInit(AnimContext ctx)
    {
        // ctx.Width / ctx.Height / ctx.Time
    }

    public void OnUpdate(float dt)
    {
        // 每帧更新逻辑
    }

    public void OnRender(ICanvas2D g)
    {
        g.Clear(new Color(8, 12, 16));
    }

    public void OnDispose()
    {
        // 释放资源
    }
}
```

目前 `ICanvas2D` 提供 `Clear` / `Line` / `Circle` / `FillCircle`，后续会继续补充绘制能力。

## 支持的 C# 子集

动画脚本会在构建时进行 C# 子集编译，子集列表见：`site/tooling/tools/animcs-compiler/SupportedFeatures.md`。

## 开发预览：`/site/pages/anim-renderer.html`

- 运行 `npm run build` 后，双击打开 `/site/pages/anim-renderer.html`。
- 用“选择仓库目录”选中项目根目录（或 `site/content/` 目录），从下拉框选择 `anims/*.cs`，再点“播放所选/复制 anim 指令”。

注意：该渲染器 **不支持** 浏览器内编译 C#，必须先构建。

## 常见问题与排错

### 1) 找不到 dotnet

编译器运行在构建阶段，仍需要 .NET 8 SDK。请确保命令行能运行 `dotnet --version`。

### 2) 页面提示“动画未构建或清单缺失”

先运行 `npm run build`，确认 `site/assets/anims/manifest.json` 与 `site/assets/anims/*.js` 已生成。

### 3) 动画没有渲染

请检查：

1. 文章里的 `{{anim:...}}` 是否以 `anims/` 开头，且以 `.cs` 结尾。
2. 是否运行过 `npm run build`（部署/提交前必须构建）。
