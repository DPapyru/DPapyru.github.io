<!DOCTYPE html>
<!-- å¼•å¯¼å­¦ä¹ ä¸å†…å®¹æŸ¥æ‰¾é¡µé¢ï¼ˆå¼•ç”¨å¼å›ç­”ï¼‰ -->
<html lang="zh-CN" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼•å¯¼å­¦ä¹ ä¸å†…å®¹æŸ¥æ‰¾ - æ³°æ‹‰ç‘äºšModåˆ¶ä½œæ•™ç¨‹</title>

    <!-- SEOä¼˜åŒ–æ ‡ç­¾ -->
    <meta name="description" content="å¼•å¯¼å­¦ä¹ ä¸å†…å®¹æŸ¥æ‰¾ï¼šæ”¯æŒè‡ªç„¶è¯­è¨€æé—®ï¼ŒåŸºäºç«™å†…æ–‡ç« æä¾›å¼•ç”¨å¼ç­”æ¡ˆä¸ç›¸å…³æ–‡ç« æ¨èã€‚">
    <meta name="keywords" content="æ³°æ‹‰ç‘äºš,Mod,æ•™ç¨‹,å¼•å¯¼å­¦ä¹ ,å†…å®¹æŸ¥æ‰¾,tModLoader,C#,æ¸¸æˆå¼€å‘">
    <meta name="robots" content="noindex, follow">

    <!-- è§„èŒƒURLï¼ˆé¿å…æœç´¢ç»“æœé¡µè¢«è¯¯æ”¶å½•ï¼‰ -->
    <link rel="canonical" href="https://dpapyru.github.io/site/search-results.html">

    <!-- æ ·å¼å’Œå›¾æ ‡ -->
    <link rel="stylesheet" href="/site/assets/css/style.css">
    <link rel="stylesheet" href="/site/assets/css/prism.min.css">
    <link rel="stylesheet" href="/site/assets/css/vs2022-theme.css">
    <link rel="icon" type="image/png" href="/site/assets/imgs/Green_tModLoader.png">
    
	    <!-- ä¸»é¢˜åˆ‡æ¢è„šæœ¬ - æ—©æœŸåŠ è½½ä»¥é¿å…é—ªçƒ -->
	    <script src="/site/assets/js/onboarding-gate.js"></script>
	    <script src="/site/assets/js/theme-init.js"></script>

	    <!-- æœç´¢ç»“æœé¡µé¢ä¸“ç”¨æ ·å¼ -->
	    <style>
	        html, body {
	            height: 100%;
	        }

	        body {
	            overflow: hidden;
	            display: flex;
	            flex-direction: column;
	            min-height: 100vh;
	        }

	        .site-header {
	            flex: 0 0 auto;
	        }

	        /* æœç´¢é¡µä»¥â€œåº”ç”¨â€å½¢å¼å‘ˆç°ï¼šéšè— footerï¼Œé¿å…é¡µé¢æ•´ä½“æ»šåŠ¨ */
	        .site-footer {
	            display: none;
	        }

	        /* æœç´¢é¡µé¢å®¹å™¨ */
	        .search-page {
	            padding: 18px 0;
	            flex: 1 1 auto;
	            min-height: 0;
	            overflow: hidden;
	        }

	        /* æœç´¢é¡µé¢å¤´éƒ¨ */
		        .search-page-header {
		            background-color: var(--bg-content);
	            padding: 30px 0;
	            border-bottom: 1px solid var(--border-color);
	            margin-bottom: 30px;
	        }

	        .search-page-title {
	            font-size: 2rem;
	            color: var(--text-color);
	            margin-bottom: 15px;
	        }

        /* é«˜çº§æœç´¢è¡¨å• */
	        .advanced-search-form {
	            background-color: var(--bg-content);
	            border-radius: 12px;
	            padding: 25px;
	            box-shadow: var(--shadow-md);
	            margin-bottom: 30px;
	        }

	        .search-form-title {
	            font-size: 1.3rem;
	            color: var(--text-color);
	            margin-bottom: 20px;
	            display: flex;
	            align-items: center;
	            gap: 10px;
	        }

        .search-form-title::before {
            content: "ğŸ”";
            font-size: 1.2rem;
        }

        .search-input-group {
            position: relative;
            margin-bottom: 20px;
        }

	        .search-input-large {
            width: 100%;
            padding: 15px 50px 15px 20px;
	            border: 2px solid var(--border-color);
	            border-radius: 50px;
	            font-size: 1.1rem;
	            outline: none;
	            transition: all 0.3s ease;
	            background-color: var(--search-bg);
	            color: var(--text-color);
	        }

	        .search-input-large:focus {
	            border-color: var(--primary-color);
	            box-shadow: 0 0 0 3px var(--search-focus);
	            background-color: var(--bg-color);
	        }

	        .search-button-large {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
	            background: var(--primary-color);
            border: none;
            color: white;
            cursor: pointer;
            padding: 12px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            width: 44px;
            height: 44px;
        }

	        .search-button-large:hover {
	            background: var(--primary-hover);
	            transform: translateY(-50%) scale(1.05);
	        }

        /* æœç´¢é€‰é¡¹ */
        .search-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .search-option-group {
            display: flex;
            flex-direction: column;
        }

	        .search-option-label {
	            font-weight: 500;
	            margin-bottom: 8px;
	            color: var(--text-secondary);
	        }

	        .search-option-select {
	            padding: 8px 12px;
	            border: 1px solid var(--border-color);
	            border-radius: 6px;
	            font-size: 0.95rem;
	            background-color: var(--bg-color);
	            color: var(--text-color);
	        }

        /* æœç´¢å¸®åŠ© */
	        .search-help {
	            background-color: var(--import-color);
	            border: 1px solid var(--primary-color);
	            border-radius: 8px;
	            padding: 15px;
	            margin-bottom: 20px;
	        }

	        .search-help-title {
	            font-weight: 600;
	            margin-bottom: 10px;
	            color: var(--text-color);
	        }

        .search-help-list {
            margin: 0;
            padding-left: 20px;
        }

	        .search-help-list li {
	            margin-bottom: 5px;
	            color: var(--text-secondary);
	        }

        /* æœç´¢å†å² */
	        .search-history {
	            background-color: var(--bg-content);
	            border-radius: 12px;
	            padding: 20px;
	            box-shadow: var(--shadow-md);
	            margin-bottom: 30px;
	        }

	        .search-history-title {
	            font-size: 1.1rem;
	            color: var(--text-color);
	            margin-bottom: 15px;
	            display: flex;
	            justify-content: space-between;
	            align-items: center;
	        }

        .clear-history-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

	        .clear-history-btn:hover {
	            background-color: var(--danger-bg);
	        }

        .search-history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

	        .search-history-item {
	            background-color: var(--bg-secondary);
	            border: 1px solid var(--border-color);
	            border-radius: 20px;
	            padding: 6px 12px;
	            font-size: 0.9rem;
	            color: var(--text-secondary);
	            cursor: pointer;
	            transition: all 0.3s ease;
	            display: flex;
	            align-items: center;
	            gap: 5px;
	        }

	        .search-history-item:hover {
	            background-color: var(--bg-tertiary);
	            color: var(--link-color);
	        }

	        .search-history-item .remove {
	            color: var(--text-muted);
	            font-size: 0.8rem;
	            margin-left: 5px;
	        }

        /* æœç´¢ç»“æœç»Ÿè®¡ */
	        .search-results-stats {
	            background-color: var(--bg-content);
	            border-radius: 12px;
	            padding: 20px;
	            box-shadow: var(--shadow-md);
	            margin-bottom: 20px;
	            display: flex;
	            justify-content: space-between;
	            align-items: center;
	        }

        /* å¼•ç”¨å¼è§£ç­”ï¼ˆå¼•å¯¼ï¼‰ */
        .guided-answer {
            background-color: var(--bg-content);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-md);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .guided-answer-title {
            font-size: 1.1rem;
            color: var(--text-color);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .guided-answer-title::before {
            content: "ğŸ§­";
            font-size: 1.1rem;
        }

        .guided-answer-list {
            display: grid;
            gap: 12px;
        }

        .guided-answer-item {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px 14px;
        }

        .guided-answer-meta {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .guided-answer-source a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .guided-answer-source a:hover {
            text-decoration: underline;
        }

        .guided-answer-snippet {
            color: var(--text-color);
            line-height: 1.6;
        }

        .guided-dialog {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px 14px;
            margin-bottom: 14px;
        }

        .guided-dialog-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 10px;
        }

        .guided-dialog-title {
            font-weight: 600;
            color: var(--text-color);
        }

        .guided-dialog-mode {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.95rem;
        }

        .guided-dialog-body {
            color: var(--text-color);
            line-height: 1.7;
        }

        .guided-dialog-body a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .guided-dialog-body a:hover {
            text-decoration: underline;
        }

        .guided-divider {
            height: 2px;
            background-color: var(--text-secondary);
            opacity: 0.9;
            margin: 12px 0;
        }

        /* å¯å±•å¼€å¡ç‰‡ï¼ˆé€šç”¨ï¼‰ */
        .expand-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 14px;
        }

        .expand-card + .expand-card {
            margin-top: 12px;
        }

        .expand-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 10px;
        }

        .expand-card-title {
            font-weight: 600;
            color: var(--text-color);
            line-height: 1.3;
        }

        .expand-card-title a {
            color: var(--text-color);
            text-decoration: none;
        }

        .expand-card-title a:hover {
            text-decoration: underline;
        }

        .expand-card-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .expand-card-body {
            color: var(--text-color);
            line-height: 1.7;
            word-break: break-word;
        }

        /* é»˜è®¤æ”¶èµ·ï¼šé™åˆ¶é«˜åº¦ï¼Œå‡å°‘å¯†é›†æ„Ÿ */
        .expand-card[data-expanded="false"] .expand-card-body {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .expand-toggle {
            flex: 0 0 auto;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 999px;
            background-color: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .expand-toggle:hover {
            border-color: var(--primary-color);
            background-color: var(--bg-content);
        }

        .mismatch-toggle {
            flex: 0 0 auto;
            padding: 6px 10px;
            border: 1px solid var(--danger-color, #dc3545);
            border-radius: 999px;
            background-color: transparent;
            color: var(--danger-color, #dc3545);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .mismatch-toggle:hover {
            background-color: var(--danger-bg);
        }

        .session-filters {
            margin-top: 12px;
            padding: 12px 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--bg-secondary);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .session-filters-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .session-filters-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .session-chip {
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 6px 10px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 0.9rem;
            max-width: 380px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .session-chip:hover {
            border-color: var(--primary-color);
        }

        .session-clear {
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-secondary);
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .session-clear:hover {
            border-color: var(--primary-color);
            color: var(--text-color);
        }

        .guided-answer-list {
            display: grid;
            gap: 14px;
        }

	        .search-results-count {
	            font-size: 1.1rem;
	            color: var(--text-color);
	        }

	        .search-results-count strong {
	            color: var(--link-color);
	        }

        .search-sort {
            display: flex;
            align-items: center;
            gap: 10px;
        }

	        .search-sort-label {
	            font-weight: 500;
	            color: var(--text-secondary);
	        }

	        .search-sort-select {
	            padding: 6px 12px;
	            border: 1px solid var(--border-color);
	            border-radius: 6px;
	            font-size: 0.9rem;
	            background-color: var(--bg-color);
	            color: var(--text-color);
	        }

        /* æœç´¢ç»“æœåˆ—è¡¨ */
	        .search-results-page {
	            background-color: var(--bg-content);
	            border-radius: 12px;
	            padding: 25px;
	            box-shadow: var(--shadow-md);
	            margin-bottom: 30px;
	        }

	        .search-result-item-page {
	            padding: 20px;
	            border-bottom: 1px solid var(--border-color);
	            transition: all 0.3s ease;
	            cursor: pointer;
	        }

        .search-result-item-page:last-child {
            border-bottom: none;
        }

	        .search-result-item-page:hover {
	            background-color: var(--sidebar-hover);
	            border-radius: 8px;
	        }

	        .search-result-title-page {
	            font-size: 1.3rem;
	            margin-bottom: 10px;
	            color: var(--text-color);
	        }

	        .search-result-description-page {
	            color: var(--text-secondary);
	            margin-bottom: 15px;
	            line-height: 1.5;
	        }

	        .search-result-snippet {
	            color: var(--text-secondary);
	            margin-bottom: 15px;
	            line-height: 1.5;
	            font-size: 0.9rem;
	            background-color: var(--bg-secondary);
	            padding: 10px;
	            border-radius: 6px;
	            border-left: 3px solid var(--link-color);
	        }

	        .search-result-snippet mark {
	            background-color: var(--highlight-bg);
	            color: var(--highlight-text);
	            padding: 2px 4px;
	            border-radius: 3px;
	            font-weight: 600;
	        }

        .search-result-meta-page {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .search-result-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

	        .search-result-score {
	            background-color: var(--primary-light);
	            color: var(--primary-color);
	        }

        /* æ— æœç´¢ç»“æœ */
	        .no-search-results {
	            text-align: center;
	            padding: 60px 20px;
	            background-color: var(--bg-content);
	            border-radius: 12px;
	            box-shadow: var(--shadow-md);
	        }

        .no-results-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

	        .no-results-title {
	            font-size: 1.5rem;
	            color: var(--text-color);
	            margin-bottom: 10px;
	        }

	        .no-results-description {
	            color: var(--text-secondary);
	            margin-bottom: 20px;
	        }

	        .no-results-suggestions {
	            background-color: var(--bg-secondary);
	            border-radius: 8px;
	            padding: 15px;
	            text-align: left;
            max-width: 500px;
            margin: 0 auto;
        }

	        .no-results-suggestions h4 {
	            margin-bottom: 10px;
	            color: var(--text-color);
	        }

        .no-results-suggestions ul {
            margin: 0;
            padding-left: 20px;
        }

	        .no-results-suggestions li {
	            margin-bottom: 5px;
	            color: var(--text-secondary);
	        }

        /* æœç´¢å»ºè®® */
	        .search-suggestions-page {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
	            background-color: var(--bg-color);
	            border: 1px solid var(--border-color);
	            border-top: none;
	            border-radius: 0 0 12px 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 8px;
        }

	        /* å“åº”å¼è®¾è®¡ */
	        @media (max-width: 768px) {
	            .search-page {
	                padding: 12px 0;
	            }

            .search-page-title {
                font-size: 1.8rem;
            }

            .search-options {
                grid-template-columns: 1fr;
            }

            .search-results-stats {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .search-sort {
                width: 100%;
                justify-content: space-between;
            }
	        }

	        /* æ–°å¸ƒå±€ï¼šèŠå¤©å¼å·¥ä½œå°ï¼ˆå·¦ï¼šå¯¹è¯å¼å¼•ç”¨ï¼Œå³ï¼šé»˜è®¤æœç´¢ï¼‰ */
	        .search-shell-container {
	            width: 100%;
	            max-width: 1600px;
	            margin: 0 auto;
	            padding: 0 16px;
	            height: 100%;
	            min-height: 0;
	        }

	        .search-shell {
	            display: grid;
	            grid-template-columns: 320px 1fr;
	            gap: 16px;
	            align-items: stretch;
	            height: 100%;
	            min-height: 0;
	        }

	        .search-sidebar {
	            display: flex;
	            flex-direction: column;
	            gap: 14px;
	            min-height: 0;
	            overflow: auto;
	        }

	        .search-workbench {
	            display: flex;
	            flex-direction: column;
	            gap: 12px;
	            min-width: 0;
	            height: 100%;
	            min-height: 0;
	        }

	        .search-page-header.compact {
	            background-color: transparent;
	            border: none;
	            padding: 0;
	            margin: 0;
	        }

	        .search-page-title.compact {
	            font-size: 1.2rem;
	            margin: 0 0 8px 0;
	        }

	        .search-page-description.compact {
	            margin: 0;
	            color: var(--text-secondary);
	            font-size: 0.95rem;
	            line-height: 1.6;
	        }

	        .workbench-split {
	            flex: 1 1 auto;
	            display: grid;
	            grid-template-columns: minmax(0, 1fr) 1px minmax(0, 1fr);
	            border: 1px solid var(--border-color);
	            border-radius: 14px;
	            background-color: var(--bg-content);
	            min-height: 460px;
	            min-width: 0;
	            min-height: 0;
	        }

	        .split-divider {
	            background-color: var(--border-color);
	        }

	        .workbench-pane {
	            padding: 16px;
	            overflow: auto;
	            min-width: 0;
	            min-height: 0;
	        }

		        .pane-title {
		            display: flex;
		            align-items: center;
		            justify-content: space-between;
		            gap: 10px;
		            margin: 0 0 12px 0;
		            color: var(--text-secondary);
		            font-size: 0.95rem;
		        }

		        .pane-title-left {
		            display: flex;
		            align-items: center;
		            gap: 8px;
		            min-width: 0;
		        }

		        .pane-title-left span {
		            white-space: nowrap;
		            overflow: hidden;
		            text-overflow: ellipsis;
		        }

		        .pane-title-right {
		            display: flex;
		            align-items: center;
		            gap: 10px;
		            flex-shrink: 0;
		        }

	        .pane-title strong {
	            color: var(--text-color);
	            font-weight: 600;
	        }

	        .workbench-pane .guided-answer,
	        .workbench-pane .search-results-page,
	        .workbench-pane .no-search-results {
	            margin-bottom: 0;
	        }

	        .workbench-composer {
	            height: 200px;
	            display: grid;
	            grid-template-columns: minmax(0, 1fr) 1px minmax(0, 1fr);
	            border: 1px solid var(--border-color);
	            border-radius: 14px;
	            background-color: var(--bg-content);
	        }

	        .composer-left {
	            padding: 16px;
	            overflow: auto;
	            color: var(--text-secondary);
	            line-height: 1.7;
	        }

	        .composer-right {
	            padding: 16px;
	            display: flex;
	            align-items: center;
	            justify-content: center;
	            min-width: 0;
	        }

	        .advanced-search-form.advanced-search-form-composer {
	            width: min(760px, 100%);
	            background-color: transparent;
	            box-shadow: none;
	            border-radius: 0;
	            padding: 0;
	            margin: 0;
	        }

	        .advanced-search-form-composer .search-form-title,
	        .advanced-search-form-composer .search-help {
	            display: none;
	        }

	        .composer-input-group {
	            position: relative;
	            margin-bottom: 12px;
	        }

	        .composer-input-group .search-input-large {
	            border-radius: 14px;
	            padding: 14px 16px 62px 16px;
	            height: 120px;
	            resize: none;
	            line-height: 1.7;
	        }

	        .composer-input-group .search-button-large {
	            position: absolute;
	            right: 12px;
	            bottom: 12px;
	            top: auto;
	            transform: none;
	            width: auto;
	            height: 44px;
	            padding: 0 16px;
	            border-radius: 12px;
	            z-index: 5;
	        }

	        .search-button-label {
	            margin-left: 6px;
	        }

	        .workbench-composer .search-suggestions-page {
	            top: auto;
	            bottom: 100%;
	            margin-top: 0;
	            margin-bottom: 10px;
	        }

		        .semantic-controls {
		            display: flex;
		            flex-direction: column;
		            gap: 6px;
		        }

		        .workbench-pane-guided .semantic-controls {
		            margin: -2px 0 12px 0;
		        }

		        .semantic-checkbox {
		            display: inline-flex;
		            align-items: center;
		            gap: 10px;
		            font-size: 0.95rem;
		            color: var(--text-secondary);
		            user-select: none;
		        }

		        .semantic-checkbox input[type="checkbox"] {
		            width: 18px;
		            height: 18px;
		            accent-color: var(--primary-color);
		        }

		        .semantic-hint {
		            font-size: 0.9rem;
		            color: var(--text-secondary);
		            line-height: 1.45;
		        }

		        .semantic-status {
		            font-size: 0.9rem;
		            line-height: 1.45;
		            color: var(--text-secondary);
		            min-height: 1.2em;
		        }

		        .semantic-status[data-state="loading"] {
		            color: var(--text-color);
		        }

		        .semantic-status[data-state="error"] {
		            color: var(--danger-color, #ff6b6b);
		        }

	        /* æœç´¢é¡µ footerï¼šä¿æŒä½†ä¸å–§å®¾å¤ºä¸»ï¼ˆéœ€è¦æ—¶å¯æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨ï¼‰ */
	        .search-page ~ .site-footer {
	            margin-top: 18px;
	        }

	        @media (max-width: 1100px) {
	            .search-shell {
	                grid-template-columns: 1fr;
	            }

	            .workbench-split,
	            .workbench-composer {
	                grid-template-columns: 1fr;
	            }

	            .split-divider {
	                display: none;
	            }

	            .workbench-composer {
	                height: 200px;
	            }

	            .composer-left {
	                display: none;
	            }

		            .semantic-controls {
		                gap: 8px;
		            }
		        }
	    </style>
	</head>

<body>
    <a class="skip-link" href="#main-content">è·³åˆ°ä¸»è¦å†…å®¹</a>
    <!-- ç½‘ç«™å¤´éƒ¨å¯¼èˆªåŒºåŸŸ -->
    <header class="site-header">
        <div class="container">
            <!-- å¤´éƒ¨å†…å®¹å®¹å™¨ï¼šåŒ…å«ç½‘ç«™logoã€å¯¼èˆªèœå•å’Œç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
            <div class="header-content">
                <!-- ç½‘ç«™logoå’Œæ ‡é¢˜ -->
                <div class="logo">
                    <a href="index.html">
                        <img src="/site/assets/imgs/Green_tModLoader.png" alt="æ³°æ‹‰ç‘äºšModåˆ¶ä½œæ•™ç¨‹" class="logo-image">
                        <h1 class="site-title">æ³°æ‹‰ç‘äºšModåˆ¶ä½œæ•™ç¨‹</h1>
                    </a>
                </div>
                <!-- ä¸»å¯¼èˆªèœå• -->
                <nav class="main-nav" id="main-nav">
                    <ul class="nav-list">
                        <li class="nav-item"><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
                        <li class="nav-item"><a href="/site/pages/folder.html" class="nav-link active" aria-current="page">æ–‡æ¡£</a></li>
                        <li class="nav-item"><a href="/site/pages/article-studio.html" class="nav-link">åœ¨çº¿å†™ä½œIDE</a></li>
                        <li class="nav-item"><a href="/site/pages/shader-playground.html" class="nav-link">Shader</a></li>
                        <li class="nav-item"><a href="qa.html" class="nav-link">é—®ç­”</a></li>
                        <li class="nav-item"><a href="https://github.com/DPapyru/DPapyru.github.io" class="nav-link" target="_blank" rel="noopener noreferrer">GitHub</a></li>
                        <li class="nav-item nav-accent">
                            <label class="visually-hidden" for="accent-select">é…è‰²</label>
                            <select class="nav-accent-select" id="accent-select" aria-label="é…è‰²">
                                <option value="green">ç»¿è‰²</option>
                                <option value="blue">è“è‰²</option>
                                <option value="purple">ç´«è‰²</option>
                                <option value="orange">æ©™è‰²</option>
                                <option value="red">çº¢è‰²</option>
                                <option value="cyan">é’è‰²</option>
                                <option value="black">é»‘è‰²</option>
                                <option value="white">ç™½è‰²</option>
                            </select>
                        </li>
                    </ul>
                </nav>
                <!-- ç§»åŠ¨ç«¯èœå•åˆ‡æ¢æŒ‰é’® -->
                <button class="mobile-menu-toggle" type="button" aria-label="åˆ‡æ¢èœå•" aria-controls="main-nav" aria-expanded="false">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </button>
            </div>
        </div>
    </header>

	    <!-- æœç´¢é¡µé¢ä¸»è¦å†…å®¹åŒºåŸŸ -->
	    <main class="search-page" id="main-content" tabindex="-1">
	        <div class="search-shell-container">
	            <div class="search-shell">
	                <aside class="search-sidebar">
	                    <div class="search-page-header compact">
	                        <h1 class="search-page-title compact">å¼•å¯¼å­¦ä¹ ä¸å†…å®¹æŸ¥æ‰¾</h1>
	                        <p class="search-page-description compact">ç”¨è‡ªç„¶è¯­è¨€æé—®ï¼›å·¦ä¾§ç»™â€œå¯¹è¯å¼å¼•ç”¨â€ï¼Œå³ä¾§ç»™â€œé»˜è®¤æœç´¢â€ç»“æœã€‚</p>
	                    </div>

	                    <!-- æœç´¢å†å² -->
	                    <div class="search-history" id="search-history-container">
	                        <div class="search-history-title">
	                            <span>æœç´¢å†å²</span>
	                            <button class="clear-history-btn" id="clear-history-btn">æ¸…é™¤å†å²</button>
	                        </div>
	                        <div class="search-history-list" id="search-history-list">
	                            <!-- æœç´¢å†å²é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
	                        </div>
	                    </div>

	                    <!-- æœç´¢å¸®åŠ© -->
	                    <div class="search-help">
	                        <h3 class="search-help-title">è¯­æ³•å¸®åŠ©</h3>
	                        <ul class="search-help-list">
	                            <li><strong>åŸºæœ¬æœç´¢ï¼š</strong>ç›´æ¥è¾“å…¥å…³é”®è¯ï¼Œå¦‚ "ç‰©å“åˆ›å»º"</li>
	                            <li><strong>ANDé€»è¾‘ï¼š</strong>ä½¿ç”¨ "+" è¿æ¥å…³é”®è¯ï¼Œå¦‚ "ç‰©å“ + åˆ›å»º"</li>
	                            <li><strong>ORé€»è¾‘ï¼š</strong>ä½¿ç”¨ç©ºæ ¼åˆ†éš”å…³é”®è¯ï¼Œå¦‚ "ç‰©å“ åˆ›å»º"</li>
	                            <li><strong>åŒ¹é…ç»„ï¼š</strong>ä½¿ç”¨æ‹¬å·ç»„åˆå…³é”®è¯ï¼Œå¦‚ "(ç‰©å“ + æ­¦å™¨) åˆ›å»º"</li>
	                            <li><strong>ç²¾ç¡®åŒ¹é…ï¼š</strong>ä½¿ç”¨å¼•å·åŒ…å›´å…³é”®è¯ï¼Œå¦‚ "Modåˆ¶ä½œ"</li>
	                        </ul>
	                    </div>
	                </aside>

	                <section class="search-workbench" aria-label="æ£€ç´¢å·¥ä½œå°">
	                    <div class="workbench-split" aria-label="ç»“æœåŒº">
		                        <div class="workbench-pane workbench-pane-guided">
		                            <div class="pane-title">
		                                <div class="pane-title-left">
		                                    <strong>å¯¹è¯å¼å¼•ç”¨</strong><span>ï¼ˆæ®µè½çº§å¼•ç”¨çº¿ç´¢ï¼‰</span>
		                                </div>
		                                <div class="pane-title-right">
		                                    <label class="semantic-checkbox" for="semantic-toggle" title="é€‚åˆè‡ªç„¶è¯­è¨€æé—®ï¼›é¦–æ¬¡ä¼šä¸‹è½½è¯­ä¹‰æ¨¡å‹ã€‚å¤±è´¥æ—¶ä¼šè‡ªåŠ¨å›é€€åˆ°è½»é‡è¯­ä¹‰ã€‚">
		                                        <input type="checkbox" id="semantic-toggle">
		                                        <span>è¯­ä¹‰å¢å¼º</span>
		                                    </label>
		                                </div>
		                            </div>

		                            <div class="semantic-controls" aria-label="è¯­ä¹‰å¢å¼º">
		                                <div class="semantic-hint" id="semantic-hint">åªåœ¨ä½ ç”¨è‡ªç„¶è¯­è¨€æè¿°é—®é¢˜æ—¶å¼€å¯ã€‚å¼€å¯åä»…ç”¨äºæå‡æ£€ç´¢æ’åºï¼Œä»åªè¾“å‡ºæ¥è‡ªæ–‡ç« çš„å¼•ç”¨æ®µè½ã€‚</div>
		                                <div class="semantic-status" id="semantic-status" data-state="idle" aria-live="polite"></div>
		                            </div>

	                            <!-- å¼•ç”¨å¼è§£ç­”ï¼ˆæ®µè½çº§çº¿ç´¢ï¼‰ -->
	                            <div class="guided-answer" id="guided-answer" style="display: none;">
	                                <h3 class="guided-answer-title">å¼•ç”¨å¼çº¿ç´¢ï¼ˆæ¥è‡ªç«™å†…æ–‡ç« ï¼‰</h3>
	                                <div class="session-filters" id="session-filters" style="display: none;">
	                                    <span class="session-filters-label">æœ¬æ¬¡ä¼šè¯å·²å±è”½çš„æ–‡ç« ï¼ˆç‚¹å‡»å¯æ’¤é”€ï¼‰ï¼š</span>
	                                    <div class="session-filters-chips" id="session-filters-chips"></div>
	                                    <button type="button" class="session-clear" id="session-filters-clear">æ¸…é™¤</button>
	                                </div>
		                                <div class="guided-dialog" id="guided-dialog" style="display: none;">
		                                    <div class="guided-dialog-header">
		                                        <span class="guided-dialog-title">å¯¹è¯æ¨¡æ¿</span>
		                                        <select class="guided-dialog-mode" id="guided-dialog-mode" aria-label="é€‰æ‹©å¯¹è¯æ¨¡æ¿">
		                                            <option value="concise">ç®€æ´</option>
		                                            <option value="clarify">æ¾„æ¸…æé—®</option>
		                                            <option value="path">é˜…è¯»é¡ºåº</option>
		                                        </select>
		                                    </div>
		                                    <div class="guided-dialog-body" id="guided-dialog-body"></div>
		                                </div>
		                                <div class="guided-divider" aria-hidden="true"></div>
		                                <div class="guided-answer-list" id="guided-answer-list"></div>
		                            </div>
		                        </div>

	                        <div class="split-divider" aria-hidden="true"></div>

	                        <div class="workbench-pane workbench-pane-default">
	                            <div class="pane-title"><strong>é»˜è®¤æœç´¢</strong><span>ï¼ˆæ–‡æ¡£çº§ç»“æœï¼‰</span></div>

	                            <!-- æœç´¢ç»“æœç»Ÿè®¡ -->
	                            <div class="search-results-stats" id="search-results-stats" style="display: none;">
	                                <div class="search-results-count">
	                                    æ‰¾åˆ° <strong id="results-count">0</strong> ä¸ªç›¸å…³ç»“æœ
	                                </div>
	                                <div class="search-sort">
	                                    <label class="search-sort-label" for="results-sort">æ’åºï¼š</label>
	                                    <select class="search-sort-select" id="results-sort">
	                                        <option value="relevance">ç›¸å…³æ€§</option>
	                                        <option value="title">æ ‡é¢˜</option>
	                                        <option value="date">æ—¥æœŸ</option>
	                                        <option value="difficulty">éš¾åº¦</option>
	                                    </select>
	                                </div>
	                            </div>

	                            <!-- æœç´¢ç»“æœåˆ—è¡¨ -->
	                            <div class="search-results-page" id="search-results-container" style="display: none;">
	                                <!-- æœç´¢ç»“æœé¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
	                            </div>

	                            <!-- æ— æœç´¢ç»“æœæç¤º -->
	                            <div class="no-search-results" id="no-search-results" style="display: none;">
	                                <div class="no-results-icon">ğŸ”</div>
	                                <h2 class="no-results-title">æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</h2>
	                                <p class="no-results-description">æˆ‘ä»¬æ‰¾ä¸åˆ°ä¸æ‚¨çš„æœç´¢è¯åŒ¹é…çš„æ•™ç¨‹å†…å®¹</p>
	                                <div class="no-results-suggestions">
	                                    <h4>æœç´¢å»ºè®®ï¼š</h4>
	                                    <ul>
	                                        <li>æ£€æŸ¥æ‹¼å†™æ˜¯å¦æ­£ç¡®</li>
	                                        <li>å°è¯•ä½¿ç”¨ä¸åŒçš„å…³é”®è¯</li>
	                                        <li>ä½¿ç”¨æ›´é€šç”¨çš„æœç´¢è¯</li>
	                                        <li>ä½¿ç”¨é«˜çº§æœç´¢è¯­æ³•ï¼Œå¦‚ "ç‰©å“ + åˆ›å»º"</li>
	                                    </ul>
	                                </div>
	                            </div>
	                        </div>
	                    </div>

	                    <div class="workbench-composer" aria-label="è¾“å…¥åŒº">
	                        <div class="composer-left">
	                            <p>å·¦ä¾§æ˜¯â€œå¼•ç”¨å¼çº¿ç´¢â€ï¼šæ¯æ¡çº¿ç´¢éƒ½æ¥è‡ªç«™å†…æ–‡ç« çš„å…·ä½“æ®µè½ã€‚</p>
	                            <p>å¦‚æœå‘ç°æ— å…³å†…å®¹ï¼Œç‚¹å¡ç‰‡ä¸Šçš„â€œä¸é¢„æœŸä¸ç¬¦â€å³å¯åœ¨æœ¬æ¬¡ä¼šè¯é‡Œå±è”½è¯¥æ–‡ç« ã€‚</p>
	                        </div>

	                        <div class="split-divider" aria-hidden="true"></div>

		                        <div class="composer-right">
		                            <div class="advanced-search-form advanced-search-form-composer">
			                                <div class="search-input-group composer-input-group">
			                                    <textarea class="search-input-large" id="advanced-search-input"
			                                        placeholder="åœ¨è¿™é‡Œç”¨è‡ªç„¶è¯­è¨€æé—®â€¦ï¼ˆEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œï¼‰" aria-label="å¼•å¯¼å­¦ä¹ ä¸å†…å®¹æŸ¥æ‰¾" autocomplete="off"></textarea>
			                                    <button class="search-button-large" id="advanced-search-button" type="button" aria-label="æœç´¢">
			                                        æŸ¥æ‰¾
			                                    </button>
			                                    <div class="search-suggestions-page" id="advanced-search-suggestions"></div>
			                                </div>
			                            </div>
			                        </div>
			                    </div>
	                </section>
	            </div>
	        </div>
	    </main>

    <!-- ç½‘ç«™åº•éƒ¨åŒºåŸŸ -->
    <footer class="site-footer">
        <div class="container">
            <!-- åº•éƒ¨å†…å®¹å®¹å™¨ -->
            <div class="footer-content">
                <!-- åº•éƒ¨ç¬¬ä¸€æ ï¼šå…³äºé¡¹ç›® -->
                <div class="footer-section">
                    <h4>å…³äºé¡¹ç›®</h4>
                    <p>è¿™æ˜¯ä¸€ä¸ªé¢å‘æ³°æ‹‰ç‘äºšModå¼€å‘è€…çš„åä½œæ•™ç¨‹é¡¹ç›®ï¼Œæ—¨åœ¨é™ä½Modåˆ¶ä½œé—¨æ§›ã€‚</p>
                </div>
                <!-- åº•éƒ¨ç¬¬äºŒæ ï¼šå¿«é€Ÿé“¾æ¥ -->
                <div class="footer-section">
                    <h4>å¿«é€Ÿé“¾æ¥</h4>
                    <ul>
                        <li><a href="index.html">é¦–é¡µ</a></li>
                        <li><a href="/site/pages/folder.html">æ•™ç¨‹ç´¢å¼•</a></li>
                        <li><a href="/site/pages/viewer.html?file=Modderå…¥é—¨/DPapyru-ç»™æ–°äººçš„å‰è¨€.md">å…¥é—¨æŒ‡å—</a></li>
                        <li><a href="/site/pages/folder.html">åŸºç¡€æ¦‚å¿µ</a></li>
                        <li><a href="https://github.com/DPapyru/DPapyru.github.io" target="_blank" rel="noopener noreferrer">GitHub</a></li>
                    </ul>
                </div>
                <!-- åº•éƒ¨ç¬¬ä¸‰æ ï¼šè”ç³»æˆ‘ä»¬ -->
                <div class="footer-section">
                    <h4>è”ç³»æˆ‘ä»¬</h4>
                    <ul>
                        <li><a href="https://github.com/DPapyru/DPapyru.github.io" target="_blank" rel="noopener noreferrer">GitHub</a></li>
                        <li><a href="mailto:contact@example.com">é‚®ç®±</a></li>
                    </ul>
                </div>
            </div>
            <!-- åº•éƒ¨ç‰ˆæƒä¿¡æ¯ -->
            <div class="footer-bottom">
                <p>&copy; 2023 æ³°æ‹‰ç‘äºšModåˆ¶ä½œæ•™ç¨‹. é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer">CC
                        BY 4.0</a> è®¸å¯åè®®ã€‚</p>
            </div>
        </div>
    </footer>

		    <!-- åŠ è½½JavaScriptæ–‡ä»¶ -->
		    <script src="/shared/assets/js/site-core.js"></script>
            <script>
                if (window.SITE) window.SITE.bootstrapPage('search');
            </script>
		    <script src="/site/assets/js/site-config.js"></script>
		    <script src="/site/assets/js/accent-theme.js"></script>
            <script src="/site/assets/js/marked.min.js"></script>
		    <script src="/site/assets/js/main.js"></script>
		    <script src="/site/assets/js/navigation.js"></script>
		        <script src="/site/assets/js/search-index-loader.js"></script>
		        <script src="/site/assets/js/bm25-lookup.js"></script>
		        <script src="/site/assets/js/guided-lookup.js"></script>
	
	    <!-- æœç´¢ç»“æœé¡µé¢ä¸“ç”¨è„šæœ¬ -->
	    <script>
        // æœç´¢ç»“æœé¡µé¢åŠŸèƒ½
        class SearchResultsPage {
		            constructor() {
		                this.searchHistory = this.loadSearchHistory();
		                this.currentQuery = this.getQueryFromURL();
		                this.searchIndex = [];
			                this.searchResults = [];
			                this.guidedEngine = null;
			                this.guidedSemanticEngine = null;
			                this.blockedDocs = new Set();
			                this.semanticEnabled = false;
			                this.semanticRuntime = 'off'; // off | dl | light
			                this.guidedUpdateToken = 0;
			                this.init();
			            }

            // åˆå§‹åŒ–
            async init() {
	                this.bindEvents();
	                await this.loadSearchIndex();
	                await this.loadGuidedEngine();
	                this.displaySearchHistory();
	                this.initSemanticControls();

                // å¦‚æœURLä¸­æœ‰æŸ¥è¯¢å‚æ•°ï¼Œæ‰§è¡Œæœç´¢
	                if (this.currentQuery) {
	                    document.getElementById('advanced-search-input').value = this.currentQuery;
	                    await this.performSearch();
	                }
	            }



            // ç»‘å®šäº‹ä»¶
            bindEvents() {
                const searchInput = document.getElementById('advanced-search-input');
	                const searchButton = document.getElementById('advanced-search-button');
	                const clearHistoryBtn = document.getElementById('clear-history-btn');
	                const resultsSort = document.getElementById('results-sort');

                // æœç´¢è¾“å…¥äº‹ä»¶
                searchInput.addEventListener('input', debounce((e) => {
                    this.handleSearchInput(e.target.value);
                }, 300));

                searchInput.addEventListener('focus', () => {
                    this.showSearchSuggestions();
                });

                searchInput.addEventListener('keydown', (e) => {
                    this.handleKeydown(e);
                });

	                // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
	                searchButton.addEventListener('click', () => {
	                    void this.performSearch();
	                });

                // æ¸…é™¤å†å²æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                clearHistoryBtn.addEventListener('click', () => {
                    this.clearSearchHistory();
                });

                // æ’åºé€‰æ‹©äº‹ä»¶
                resultsSort.addEventListener('change', () => {
                    this.sortSearchResults(resultsSort.value);
                });

	                // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—æœç´¢å»ºè®®
	                document.addEventListener('click', (e) => {
	                    if (!e.target.closest('.search-input-group')) {
	                        this.hideSearchSuggestions();
                    }
                });

                this.bindExpandCards();

                const clearSessionFilters = document.getElementById('session-filters-clear');
	                if (clearSessionFilters) {
	                    clearSessionFilters.addEventListener('click', () => {
	                        this.blockedDocs.clear();
	                        this.renderSessionFilters();
	                        void this.refreshCurrentResults();
	                    });
	                }
	            }

		            initSemanticControls() {
		                const toggle = document.getElementById('semantic-toggle');
		                const status = document.getElementById('semantic-status');
		                if (!toggle || !status) return;

		                // é»˜è®¤ä¸€ç›´å¼€å¯ï¼ˆä¸ä¾èµ–æ¨ç†åç«¯ï¼›ä½¿ç”¨æ„å»ºæœŸ guided-index è½»é‡è¯­ä¹‰ï¼‰
		                this.semanticEnabled = true;
		                this.semanticRuntime = 'light';
		                toggle.checked = true;
		                toggle.disabled = true;

		                status.dataset.state = 'idle';
		                status.textContent = '';
		                status.title = '';
		                status.style.display = 'none';

		                void this.loadGuidedSemanticEngine();
		            }

	            bindExpandCards() {
	                if (document.body.__expandCardsBound) return;
	                document.body.__expandCardsBound = true;
	                document.body.__expandCardsOwner = this;

                document.addEventListener('click', (e) => {
                    const chip = e.target.closest('.session-chip');
                    if (chip) {
                        e.preventDefault();
                        e.stopPropagation();

                        const encoded = chip.getAttribute('data-doc-path') || '';
                        let docPath = '';
                        try {
                            docPath = decodeURIComponent(encoded);
                        } catch {
                            docPath = encoded;
                        }

                        const owner = document.body.__expandCardsOwner;
                        if (!owner || !docPath) return;

                        owner.blockedDocs.delete(docPath);
                        owner.renderSessionFilters();
                        owner.refreshCurrentResults();
                        return;
                    }

                    const mismatch = e.target.closest('.mismatch-toggle');
                    if (mismatch) {
                        e.preventDefault();
                        e.stopPropagation();

                        const card = mismatch.closest('[data-doc-path]');
                        if (!card) return;
                        const encoded = card.getAttribute('data-doc-path') || '';
                        let docPath = '';
                        try {
                            docPath = decodeURIComponent(encoded);
                        } catch {
                            docPath = encoded;
                        }

                        const owner = document.body.__expandCardsOwner;
                        if (!owner || !docPath) return;

                        owner.blockedDocs.add(docPath);
                        owner.renderSessionFilters();
                        owner.refreshCurrentResults();
                        return;
                    }

                    const btn = e.target.closest('.expand-toggle');
                    if (!btn) return;

                    e.preventDefault();
                    e.stopPropagation();

                    const card = btn.closest('.expand-card');
                    if (!card) return;

                    const expanded = card.getAttribute('data-expanded') === 'true';
                    const next = expanded ? 'false' : 'true';
                    card.setAttribute('data-expanded', next);
                    btn.setAttribute('aria-expanded', next);
                    btn.textContent = expanded ? 'å±•å¼€' : 'æ”¶èµ·';
                });
            }

            renderSessionFilters() {
                const box = document.getElementById('session-filters');
                const chips = document.getElementById('session-filters-chips');
                if (!box || !chips) return;

                const items = Array.from(this.blockedDocs);
                if (items.length === 0) {
                    box.style.display = 'none';
                    chips.innerHTML = '';
                    return;
                }

                const esc = (window.SiteUtils && typeof window.SiteUtils.escapeHtml === 'function')
                    ? window.SiteUtils.escapeHtml
                    : (v) => String(v).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s]));

                const labelForPath = (p) => {
                    const hit = (this.searchIndex || []).find(d => d && d.path === p);
                    if (hit && hit.title) return hit.title;
                    const base = p.split('/').pop();
                    return base || p;
                };

                chips.innerHTML = items.map(p => {
                    const t = esc(labelForPath(p));
                    const encoded = encodeURIComponent(p);
                    return `<button type="button" class="session-chip" data-doc-path="${encoded}" title="ç‚¹å‡»æ’¤é”€">å·²å±è”½ï¼šã€Š${t}ã€‹</button>`;
                }).join('');
                box.style.display = 'flex';
            }

	            refreshCurrentResults() {
	                // ä¸æ›´æ–° URL / å†å²ï¼Œä»…åˆ·æ–°å±•ç¤º
	                if (!this.currentQuery) return;
	                void this.updateGuidedAnswer();
	                this.applyBlockedDocsToSearchResults();
	                this.displaySearchResults();
	            }

            applyBlockedDocsToSearchResults() {
                if (!this.blockedDocs || this.blockedDocs.size === 0) return;
                this.searchResults = (this.searchResults || []).filter(r => !this.blockedDocs.has(r.path || ''));
            }

            // ä»URLè·å–æŸ¥è¯¢å‚æ•°
            getQueryFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const query = urlParams.get('q') || '';
                console.log('ä»URLè·å–çš„åŸå§‹æŸ¥è¯¢:', query);
                // è§£ç URLç¼–ç çš„å­—ç¬¦
                const decodedQuery = decodeURIComponent(query);
                console.log('è§£ç åçš„æŸ¥è¯¢:', decodedQuery);
                return decodedQuery;
            }

            // æ›´æ–°URL
            updateURL(query) {
                const url = new URL(window.location);
                if (query) {
                    url.searchParams.set('q', query);
                } else {
                    url.searchParams.delete('q');
                }
                window.history.replaceState({}, '', url);
            }

            // åŠ è½½æœç´¢ç´¢å¼•
            async loadSearchIndex() {
                try {
                    const loaded = await this.loadSearchIndexFromJson();
                    if (loaded) {
                        console.log(`å·²ä» search-index.json åŠ è½½ç´¢å¼•ï¼Œå…± ${this.searchIndex.length} ä¸ªæ•™ç¨‹`);
                        return;
                    }

                    // é¦–å…ˆå°è¯•ä»config.jsonè·å–æ–‡æ¡£åˆ—è¡¨
                    let tutorialFiles = await this.getTutorialFilesFromConfig();

                    // å¦‚æœconfig.jsonè·å–å¤±è´¥æˆ–ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„
                    if (!tutorialFiles || tutorialFiles.length === 0) {
                        tutorialFiles = await this.getTutorialFiles();
                    }

                    // ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºç´¢å¼•
                    for (const file of tutorialFiles) {
                        try {
                            const response = await fetch(encodeURI(file)); // ä½¿ç”¨fetchè·å–æ–‡ä»¶å†…å®¹ï¼ˆå…¼å®¹ç©ºæ ¼/ä¸­æ–‡è·¯å¾„ï¼‰
                            if (!response.ok) continue;

                            const content = await response.text(); // ä½¿ç”¨text()æ–¹æ³•è·å–æ–‡ä»¶å†…å®¹
                            const metadata = await this.parseMetadataWithConfig(content, file.split('/').pop()); // ä½¿ç”¨parseMetadataWithConfigæ–¹æ³•è§£ææ–‡ä»¶å…ƒæ•°æ®
                            const plainText = this.stripMarkdown(content); // ä½¿ç”¨stripMarkdownæ–¹æ³•å»é™¤Markdownæ ¼å¼

                            // æ›´æ–°URLï¼Œä½¿å…¶æŒ‡å‘viewer.htmlå¹¶åŠ è½½ç›¸åº”çš„æ–‡ä»¶ï¼ˆä¿ç•™å®Œæ•´ç›¸å¯¹è·¯å¾„ï¼‰
                            const relativePath = file.replace(/^docs\//, '');
                            const viewerUrl = `/site/pages/viewer.html?file=${encodeURIComponent(relativePath)}`;
                            console.log('æ›´æ–°åçš„URL:', viewerUrl);

                            this.searchIndex.push({
                                title: metadata.title || this.extractTitle(content),
                                url: viewerUrl,
                                content: plainText,
                                description: metadata.description || this.extractDescription(plainText),
                                category: metadata.category || this.getCategoryFromPath(file),
                                difficulty: metadata.difficulty || 'æœªçŸ¥',
                                time: metadata.time || metadata.estimated_time || 'æœªçŸ¥',
                                author: metadata.author || 'æœªçŸ¥',
                                date: metadata.date || metadata.last_updated || 'æœªçŸ¥',
                                path: metadata.path || relativePath
                            });
                        } catch (error) {
                            console.warn(`æ— æ³•åŠ è½½æ–‡ä»¶ ${file}:`, error);
                        }
                    }

                    console.log(`æœç´¢ç´¢å¼•åŠ è½½å®Œæˆï¼Œå…± ${this.searchIndex.length} ä¸ªæ•™ç¨‹`);
                } catch (error) {
                    console.error('åŠ è½½æœç´¢ç´¢å¼•å¤±è´¥:', error);
                }
            }

            getViewerBase() {
                return (window.SiteUtils && typeof window.SiteUtils.getViewerBase === 'function')
                    ? window.SiteUtils.getViewerBase()
                    : '/site/pages/viewer.html';
            }

            async loadSearchIndexFromJson() {
                try {
                    let payload = null;
                    if (window.SearchIndexLoader && typeof window.SearchIndexLoader.load === 'function') {
                        payload = await window.SearchIndexLoader.load('/site/assets/search-index.json');
                    } else {
                        const response = await fetch('/site/assets/search-index.json');
                        if (!response.ok) return false;
                        payload = await response.json();
                    }
                    if (!payload || !Array.isArray(payload.docs)) return false;

                    const viewerBase = this.getViewerBase();
                    this.searchIndex = payload.docs.map(doc => {
                        const relativePath = doc.path || doc.filename;
                        return {
                            title: doc.title || '',
                            url: `${viewerBase}?file=${encodeURIComponent(relativePath)}`,
                            content: doc.content || '',
                            description: doc.description || '',
                            category: doc.category || 'æœªåˆ†ç±»',
                            difficulty: doc.difficulty || 'æœªçŸ¥',
                            time: doc.time || 'æœªçŸ¥',
                            author: doc.author || 'æœªçŸ¥',
                            date: doc.last_updated || 'æœªçŸ¥',
                            path: relativePath
                        };
                    });

                    return this.searchIndex.length > 0;
                } catch (error) {
                    console.warn('search-index.json åŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°é€æ–‡ä»¶ç´¢å¼•:', error);
                    return false;
                }
            }

	            async loadGuidedEngine() {
	                try {
	                    if (!window.Bm25LookupEngine) return;
	                    this.guidedEngine = await window.Bm25LookupEngine.load('/site/assets/semantic/bm25-index.v1.json');
	                    console.log('bm25-index å·²åŠ è½½ï¼š', this.guidedEngine.chunkCount, 'chunks');
	                } catch (error) {
	                    console.warn('bm25-index åŠ è½½å¤±è´¥ï¼Œå°†ä»…æ˜¾ç¤ºæ™®é€šæœç´¢ç»“æœ:', error);
	                    this.guidedEngine = null;
	                }
	            }

	            async loadGuidedSemanticEngine() {
	                if (this.guidedSemanticEngine) return this.guidedSemanticEngine;
	                try {
	                    if (!window.GuidedLookupEngine) return null;
	                    this.guidedSemanticEngine = await window.GuidedLookupEngine.load('/site/assets/semantic/guided-index.v1.json');
	                    console.log('guided-index å·²åŠ è½½ï¼š', this.guidedSemanticEngine.chunkCount, 'chunks');
	                    return this.guidedSemanticEngine;
	                } catch (error) {
	                    console.warn('guided-index åŠ è½½å¤±è´¥ï¼š', error);
	                    this.guidedSemanticEngine = null;
	                    return null;
	                }
	            }
	
	            // ä»config.jsonè·å–æ‰€æœ‰æ•™ç¨‹æ–‡ä»¶
	            async getTutorialFilesFromConfig() {
	                try {
                    const config = await (window.SiteConfig ? window.SiteConfig.load() : fetch('/site/content/config.json').then(r => {
                        if (!r.ok) throw new Error(`æ— æ³•åŠ è½½config.json: ${r.status}`);
                        return r.json();
                    }));

                    // ä»config.jsonä¸­æå–æ‰€æœ‰æ–‡æ¡£æ–‡ä»¶
                    const documents = [];

                    // ä½¿ç”¨all_filesæ•°ç»„ï¼Œè¿™æ˜¯æœ€ç›´æ¥çš„æ–‡æ¡£åˆ—è¡¨
                    if (config.all_files && Array.isArray(config.all_files)) {
                        config.all_files.forEach(file => {
                            documents.push(`/site/content/${file.path}`);
                        });
                    } else {
                        // å¦‚æœall_filesä¸å­˜åœ¨ï¼Œå›é€€åˆ°éå†ç±»åˆ«å’Œä¸»é¢˜
                        Object.values(config.categories).forEach(category => {
                            Object.values(category.topics).forEach(topic => {
                                topic.files.forEach(file => {
                                    documents.push(`/site/content/${file.filename}`);
                                });
                            });
                        });
                    }

                    console.log('ä»config.jsonè·å–çš„æ–‡æ¡£åˆ—è¡¨:', documents);
                    return documents;
                } catch (error) {
                    console.error('è·å–config.jsonå¤±è´¥:', error);
                    return []; // è¿”å›ç©ºæ•°ç»„ï¼Œè®©è°ƒç”¨è€…ä½¿ç”¨é»˜è®¤è·¯å¾„
                }
            }

            // è·å–æ‰€æœ‰æ•™ç¨‹æ–‡ä»¶ï¼ˆé»˜è®¤åå¤‡æ–¹æ¡ˆï¼‰
            async getTutorialFiles() {
                // è¿”å›æ‰€æœ‰æ•™ç¨‹æ–‡ä»¶çš„è·¯å¾„ï¼ˆåå¤‡æ–¹æ¡ˆï¼‰
                return [
                    '/site/content/Modderå…¥é—¨/DPapyru-ç»™æ–°äººçš„å‰è¨€.md',
                    '/site/content/æ€ä¹ˆè´¡çŒ®/æ•™å­¦æ–‡ç« å†™ä½œæŒ‡å—.md',
                    '/site/content/æ€ä¹ˆè´¡çŒ®/TopicSystemä½¿ç”¨æŒ‡å—.md'
                ];
            }

	            // è§£ææ–‡ä»¶å…ƒæ•°æ® - å¢å¼ºç‰ˆï¼Œæ”¯æŒä»config.jsonè·å–å…ƒæ•°æ®
	            async parseMetadataWithConfig(content, fileName) {
	                let metadata = this.parseMetadata(content);

                // å°è¯•ä»config.jsonè·å–æ›´å®Œæ•´çš„å…ƒæ•°æ®
                try {
                    const config = await (window.SiteConfig ? window.SiteConfig.load() : fetch('/site/content/config.json').then(r => {
                        if (!r.ok) throw new Error(`æ— æ³•åŠ è½½config.json: ${r.status}`);
                        return r.json();
                    }));

                        // åœ¨all_filesä¸­æŸ¥æ‰¾å½“å‰æ–‡ä»¶
                        const fileInfo = config.all_files.find(file => file.filename === fileName);
                        if (fileInfo) {
                            // åˆå¹¶config.jsonä¸­çš„å…ƒæ•°æ®
                            metadata = {
                                ...metadata,
                                title: fileInfo.title || metadata.title,
                                author: fileInfo.author || metadata.author,
                                category: fileInfo.category || metadata.category,
                                topic: fileInfo.topic || metadata.topic,
                                order: fileInfo.order || metadata.order,
                                path: fileInfo.path || metadata.path,
                            };

                            // ä»categoriesä¸­è·å–æ›´å¤šä¿¡æ¯
                            if (fileInfo.category && config.categories[fileInfo.category]) {
                                const categoryInfo = config.categories[fileInfo.category];
                                if (categoryInfo.topics[fileInfo.topic]) {
                                    const topicInfo = categoryInfo.topics[fileInfo.topic];
                                    const fileInTopic = topicInfo.files.find(f => f.filename === fileName);
                                    if (fileInTopic) {
                                        metadata = {
                                            ...metadata,
                                            title: fileInTopic.title || metadata.title,
                                            author: fileInTopic.author || metadata.author,
                                            description: fileInTopic.description || metadata.description,
                                            last_updated: fileInTopic.last_updated || metadata.last_updated,
                                            order: fileInTopic.order || metadata.order,
                                            path: fileInfo.path || metadata.path,
                                        };
                                    }
                                }
                            }
                        }
                } catch (error) {
                    console.warn('ä»config.jsonè·å–å…ƒæ•°æ®å¤±è´¥:', error);
                }

                return metadata;
            }

            // ä»æ–‡ä»¶è·¯å¾„è·å–åˆ†ç±»
            getCategoryFromPath(filePath) {
                const match = filePath.match(/docs\/([^\/]+)/);
                return match ? match[1] : 'æœªåˆ†ç±»';
            }

            // è§£ææ–‡ä»¶å…ƒæ•°æ®
            parseMetadata(content) {
                const metadataMatch = content.match(/^---\n(.*?)\n---/s);
                if (!metadataMatch) return {};

                const metadata = {};
                const lines = metadataMatch[1].split('\n');

                lines.forEach(line => {
                    const [key, ...valueParts] = line.split(':');
                    if (key && valueParts.length > 0) {
                        metadata[key.trim()] = valueParts.join(':').trim();
                    }
                });

                // å¤„ç†æ–°æ–‡æ¡£ç»“æ„ä¸­çš„å…ƒæ•°æ®å­—æ®µæ˜ å°„
                // å°†estimated_timeæ˜ å°„åˆ°timeï¼Œå°†last_updatedæ˜ å°„åˆ°date
                if (metadata.estimated_time && !metadata.time) {
                    metadata.time = metadata.estimated_time;
                }
                if (metadata.last_updated && !metadata.date) {
                    metadata.date = metadata.last_updated;
                }

                return metadata;
            }

            // æå–æ ‡é¢˜
            extractTitle(content) {
                const titleMatch = content.match(/^#\s+(.+)$/m);
                return titleMatch ? titleMatch[1] : 'æ— æ ‡é¢˜';
            }

            // æå–æè¿°
            extractDescription(plainText) {
                // å–å‰100ä¸ªå­—ç¬¦ä½œä¸ºæè¿°
                return plainText.substring(0, 100).trim() + '...';
            }

            // å»é™¤Markdownæ ‡è®°
            stripMarkdown(content) {
                // ç§»é™¤å…ƒæ•°æ®
                content = content.replace(/^---\n.*?\n---\n/s, '');

                // ç§»é™¤ä»£ç å—
                content = content.replace(/```[\s\S]*?```/g, '');

                // ç§»é™¤è¡Œå†…ä»£ç 
                content = content.replace(/`[^`]*`/g, '');

                // ç§»é™¤é“¾æ¥
                content = content.replace(/\[([^\]]*)\]\([^)]*\)/g, '$1');

                // ç§»é™¤å›¾ç‰‡
                content = content.replace(/!\[([^\]]*)\]\([^)]*\)/g, '$1');

                // ç§»é™¤æ ‡é¢˜æ ‡è®°
                content = content.replace(/^#{1,6}\s+/gm, '');

                // ç§»é™¤åŠ ç²—å’Œæ–œä½“æ ‡è®°
                content = content.replace(/\*\*([^*]*)\*\*/g, '$1');
                content = content.replace(/\*([^*]*)\*/g, '$1');
                content = content.replace(/__([^_]*)__/g, '$1');
                content = content.replace(/_([^_]*)_/g, '$1');

                // ç§»é™¤åˆ—è¡¨æ ‡è®°
                content = content.replace(/^[-*+]\s+/gm, '');
                content = content.replace(/^\d+\.\s+/gm, '');

                // ç§»é™¤å¼•ç”¨æ ‡è®°
                content = content.replace(/^>\s+/gm, '');

                // ç§»é™¤å¤šä½™çš„æ¢è¡Œç¬¦
                content = content.replace(/\n+/g, ' ');

                return content.trim();
            }

            // å¤„ç†æœç´¢è¾“å…¥
            handleSearchInput(query) {
                this.currentQuery = query.trim();

                if (this.currentQuery) {
                    this.showSearchSuggestions();
                } else {
                    this.hideSearchSuggestions();
                }
            }

            // æ˜¾ç¤ºæœç´¢å»ºè®®
            showSearchSuggestions() {
                if (!this.currentQuery) return;

                const suggestions = this.getSuggestions(this.currentQuery);
                const suggestionsContainer = document.getElementById('advanced-search-suggestions');

                if (suggestions.length === 0) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                suggestionsContainer.innerHTML = '';

                suggestions.forEach(suggestion => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = this.highlightText(suggestion.title, this.currentQuery);

	                    item.addEventListener('click', () => {
	                        document.getElementById('advanced-search-input').value = suggestion.title;
	                        this.currentQuery = suggestion.title;
	                        void this.performSearch();
	                    });

                    suggestionsContainer.appendChild(item);
                });

                suggestionsContainer.style.display = 'block';
            }

            // éšè—æœç´¢å»ºè®®
            hideSearchSuggestions() {
                const suggestionsContainer = document.getElementById('advanced-search-suggestions');
                if (suggestionsContainer) {
                    suggestionsContainer.style.display = 'none';
                }
            }

            // è·å–æœç´¢å»ºè®®
            getSuggestions(query) {
                if (!query) return [];

                const lowerQuery = query.toLowerCase();
                return this.searchIndex
                    .filter(item => (item.title || '').toLowerCase().includes(lowerQuery))
                    .slice(0, 5); // æœ€å¤šæ˜¾ç¤º5ä¸ªå»ºè®®
            }

            // å¤„ç†é”®ç›˜äº‹ä»¶
	            handleKeydown(e) {
	                const suggestionsContainer = document.getElementById('advanced-search-suggestions');
	                if (!suggestionsContainer) return;

	                const suggestions = suggestionsContainer.querySelectorAll('.suggestion-item');

		                if (e.key === 'Enter' && !e.shiftKey) {
		                    e.preventDefault();
		                    void this.performSearch();
		                } else if (e.key === 'Escape') {
		                    this.hideSearchSuggestions();
		                }
		            }

            // æ‰§è¡Œæœç´¢
            async performSearch() {
                if (!this.currentQuery) return;

                // æ·»åŠ åˆ°æœç´¢å†å²
                this.addToSearchHistory(this.currentQuery);

                // æ›´æ–°URL
                this.updateURL(this.currentQuery);

                // éšè—æœç´¢å»ºè®®
                this.hideSearchSuggestions();

                // æ‰§è¡Œé«˜çº§æœç´¢
                this.searchResults = this.advancedSearch(this.currentQuery);

	                // å¼•å¯¼å¼å¼•ç”¨çº¿ç´¢ï¼ˆæ®µè½çº§ï¼‰
	                await this.updateGuidedAnswer();
	                this.applyBlockedDocsToSearchResults();
	                this.renderSessionFilters();

                // æ˜¾ç¤ºæœç´¢ç»“æœ
                this.displaySearchResults();
            }

            // é«˜çº§æœç´¢ç®—æ³•
            advancedSearch(query) {
                if (!query) return [];

                // è§£ææœç´¢æŸ¥è¯¢
                const searchQuery = this.parseSearchQuery(query);

                const results = [];

                this.searchIndex.forEach(item => {
                    const score = this.calculateRelevanceScore(item, searchQuery);

                    if (score > 0) {
                        // ç”ŸæˆåŒ¹é…ç‰‡æ®µ
                        const snippet = this.generateSnippet(item.content, searchQuery);

                        results.push({
                            ...item,
                            score,
                            snippet
                        });
                    }
                });

                // æŒ‰å¾—åˆ†æ’åº
                return results.sort((a, b) => b.score - a.score);
            }

            // è§£ææœç´¢æŸ¥è¯¢
            parseSearchQuery(query) {
                // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„æŸ¥è¯¢è§£æå™¨ï¼Œæ”¯æŒåŸºæœ¬çš„ANDã€ORå’Œæ‹¬å·
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯èƒ½éœ€è¦æ›´å¤æ‚çš„è§£æå™¨

                // æ·»åŠ è°ƒè¯•æ—¥å¿—
                console.log('æœç´¢ç»“æœé¡µé¢ - åŸå§‹æŸ¥è¯¢:', query);

                // å¤„ç†URLç¼–ç çš„å­—ç¬¦
                query = decodeURIComponent(query);
                console.log('æœç´¢ç»“æœé¡µé¢ - è§£ç åæŸ¥è¯¢:', query);

                // ç§»é™¤å¤šä½™çš„ç©ºæ ¼
                query = query.trim().replace(/\s+/g, ' ');
                console.log('æœç´¢ç»“æœé¡µé¢ - è§„èŒƒåŒ–åæŸ¥è¯¢:', query);

                // å¤„ç†ç²¾ç¡®åŒ¹é…ï¼ˆå¼•å·åŒ…å›´çš„çŸ­è¯­ï¼‰
                const exactMatches = [];
                const exactMatchRegex = /"([^"]+)"/g;
                let match;
                while ((match = exactMatchRegex.exec(query)) !== null) {
                    exactMatches.push(match[1].toLowerCase());
                }
                console.log('æœç´¢ç»“æœé¡µé¢ - ç²¾ç¡®åŒ¹é…é¡¹:', exactMatches);

                // ç§»é™¤ç²¾ç¡®åŒ¹é…éƒ¨åˆ†ï¼Œå¤„ç†å‰©ä½™æŸ¥è¯¢
                query = query.replace(/"[^"]+"/g, '').trim();

                // å¤„ç†æ‹¬å·ç»„ï¼ˆå…ˆå¤„ç†æ‹¬å·ï¼Œå› ä¸ºæ‹¬å·å†…å¯èƒ½åŒ…å«AND/ORæ“ä½œï¼‰
                const bracketGroups = [];
                const bracketRegex = /\(([^)]+)\)/g;
                while ((match = bracketRegex.exec(query)) !== null) {
                    bracketGroups.push(match[1].toLowerCase());
                }
                console.log('æœç´¢ç»“æœé¡µé¢ - æ‹¬å·ç»„:', bracketGroups);

                // ç§»é™¤æ‹¬å·éƒ¨åˆ†
                query = query.replace(/\([^)]+\)/g, '').trim();

                // å¤„ç†ANDæ“ä½œï¼ˆ+å·ï¼‰
                const andTerms = [];
                const andTermRegex = /\+([^\s+]+)/g;
                while ((match = andTermRegex.exec(query)) !== null) {
                    andTerms.push(match[1].toLowerCase());
                }
                console.log('æœç´¢ç»“æœé¡µé¢ - ANDé¡¹:', andTerms);

                // ç§»é™¤ANDæ“ä½œéƒ¨åˆ†
                query = query.replace(/\+[^\s+]+/g, '').trim();

                // å‰©ä½™çš„éƒ¨åˆ†ä½œä¸ºORæ“ä½œ
                const orTerms = query ? query.split(' ').filter(term => term) : [];
                console.log('æœç´¢ç»“æœé¡µé¢ - ORé¡¹:', orTerms);

                return {
                    exactMatches,
                    andTerms,
                    orTerms,
                    bracketGroups,
                    originalQuery: query
                };
            }

            // è®¡ç®—ç›¸å…³æ€§å¾—åˆ†
            calculateRelevanceScore(item, searchQuery) {
                let score = 0;
                const title = (item.title || '').toLowerCase();
                const content = (item.content || '').toLowerCase();
                const description = (item.description || '').toLowerCase();
                const category = (item.category || '').toLowerCase();

                // æ”¶é›†æ‰€æœ‰æœç´¢è¯
                const allTerms = [
                    ...searchQuery.exactMatches,
                    ...searchQuery.andTerms,
                    ...searchQuery.orTerms,
                    ...searchQuery.bracketGroups.flatMap(group => group.split(' '))
                ].filter(term => term.trim() !== '');

                // ç²¾ç¡®åŒ¹é…å¾—åˆ†æœ€é«˜
                searchQuery.exactMatches.forEach(term => {
                    if (title.includes(term)) score += 50;
                    if (description.includes(term)) score += 25;
                    if (content.includes(term)) score += 10;
                    if (category.includes(term)) score += 15;
                });

                // ANDæ“ä½œå¾—åˆ†è¾ƒé«˜
                searchQuery.andTerms.forEach(term => {
                    if (title.includes(term)) score += 20;
                    if (description.includes(term)) score += 10;
                    if (content.includes(term)) score += 5;
                    if (category.includes(term)) score += 8;
                });

                // ORæ“ä½œå¾—åˆ†è¾ƒä½
                searchQuery.orTerms.forEach(term => {
                    if (title.includes(term)) score += 10;
                    if (description.includes(term)) score += 5;
                    if (content.includes(term)) score += 2;
                    if (category.includes(term)) score += 3;
                });

                // æ‹¬å·ç»„å¾—åˆ†ä¸­ç­‰
                searchQuery.bracketGroups.forEach(group => {
                    const groupTerms = group.split(' ');
                    let groupScore = 0;

                    groupTerms.forEach(term => {
                        if (title.includes(term)) groupScore += 15;
                        if (description.includes(term)) groupScore += 8;
                        if (content.includes(term)) groupScore += 3;
                        if (category.includes(term)) groupScore += 5;
                    });

                    // å¦‚æœç»„å†…æœ‰å¤šä¸ªåŒ¹é…ï¼Œç»™äºˆé¢å¤–å¥–åŠ±
                    if (groupScore > 15) {
                        score += groupScore * 1.5;
                    } else {
                        score += groupScore;
                    }
                });

                // å®Œå…¨åŒ¹é…å¾—åˆ†æ›´é«˜
                if (title === searchQuery.originalQuery.toLowerCase()) score += 100;

                // ä¸­æ–‡æœç´¢ä¼˜åŒ–ï¼šå¦‚æœæœç´¢è¯æ˜¯ä¸­æ–‡ï¼Œå¢åŠ å¯¹å®Œæ•´åŒ¹é…çš„æƒé‡
                allTerms.forEach(term => {
                    if (this.isChinese(term)) {
                        if (title.includes(term)) score += 15;
                        if (content.includes(term)) score += 8;
                        if (description.includes(term)) score += 10;
                    }
                });

                return score;
            }

            // ç”ŸæˆåŒ¹é…ç‰‡æ®µ
            generateSnippet(content, searchQuery) {
                // æ”¶é›†æ‰€æœ‰æœç´¢è¯
                const allTerms = [
                    ...searchQuery.exactMatches,
                    ...searchQuery.andTerms,
                    ...searchQuery.orTerms,
                    ...searchQuery.bracketGroups.flatMap(group => group.split(' '))
                ].filter(term => term.trim() !== '');

                if (allTerms.length === 0) return '';

                // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…çš„ä½ç½®
                let firstMatchIndex = -1;
                let matchedTerm = '';

                for (const term of allTerms) {
                    const index = (content || '').toLowerCase().indexOf(term.toLowerCase());
                    if (index !== -1 && (firstMatchIndex === -1 || index < firstMatchIndex)) {
                        firstMatchIndex = index;
                        matchedTerm = term;
                    }
                }

                if (firstMatchIndex === -1) return '';

                // æå–ç‰‡æ®µï¼ˆå‰åå„50ä¸ªå­—ç¬¦ï¼‰
                const start = Math.max(0, firstMatchIndex - 50);
                const end = Math.min(content.length, firstMatchIndex + matchedTerm.length + 50);
                let snippet = content.substring(start, end);

                // æ·»åŠ çœç•¥å·
                if (start > 0) snippet = '...' + snippet;
                if (end < content.length) snippet = snippet + '...';

                // é«˜äº®åŒ¹é…çš„è¯
                snippet = this.highlightText(snippet, matchedTerm);

                return snippet;
            }

            // åˆ¤æ–­æ˜¯å¦ä¸ºä¸­æ–‡å­—ç¬¦
            isChinese(text) {
                return /[\u4e00-\u9fa5]/.test(text);
            }

	            async updateGuidedAnswer() {
	                const token = ++this.guidedUpdateToken;
	                const container = document.getElementById('guided-answer');
	                const list = document.getElementById('guided-answer-list');
	                const dialog = document.getElementById('guided-dialog');
	                const dialogMode = document.getElementById('guided-dialog-mode');
	                const dialogBody = document.getElementById('guided-dialog-body');
	                if (!container || !list) return;
	
		                if (!this.currentQuery) {
		                    container.style.display = 'none';
		                    list.innerHTML = '';
		                    if (dialog) dialog.style.display = 'none';
		                    if (dialogBody) dialogBody.innerHTML = '';
		                    return;
		                }

		                const hasBm25 = !!this.guidedEngine;
		                const semanticOn = !!this.semanticEnabled;

		                let candidates = [];
		                if (hasBm25) {
		                    try {
		                        candidates = this.guidedEngine.search(this.currentQuery, {
		                            limit: semanticOn ? 24 : 8,
		                            docLimit: semanticOn ? 18 : 12,
		                            maxPerDoc: 3,
		                            blockedDocs: this.blockedDocs
		                        });
		                    } catch (error) {
		                        console.warn('guided search å¤±è´¥:', error);
		                        candidates = [];
		                    }
		                }

		                if (!hasBm25 && !semanticOn) {
		                    container.style.display = 'none';
		                    list.innerHTML = '';
		                    if (dialog) dialog.style.display = 'none';
		                    if (dialogBody) dialogBody.innerHTML = '';
		                    return;
		                }
		
		                if (token !== this.guidedUpdateToken) return;

			                const routing = (this.guidedEngine && typeof this.guidedEngine.classifyQuery === 'function')
			                    ? this.guidedEngine.classifyQuery(this.currentQuery)
			                    : null;
			                const intent = routing && routing.intent ? routing.intent : 'unknown';
			                const conceptMode = !!(routing && routing.flags && routing.flags.hasConcept);
			                const weightSemantic = (intent === 'intro' || intent === 'concept' || conceptMode)
			                    ? 0.7
			                    : (intent === 'howto' ? 0.35 : 0.5);
			                const weightLexical = 1 - weightSemantic;

			                const expandSyn = (term) => {
			                    const t = String(term || '').toLowerCase();
			                    if (!t) return [t];
			                    const table = {
			                        'ç‰©å“': ['ç‰©å“', 'item', 'moditem', 'setdefaults'],
			                        'æ­¦å™¨': ['æ­¦å™¨', 'weapon', 'shoot', 'useitem', 'melee'],
			                        'å¼¹å¹•': ['å¼¹å¹•', 'projectile', 'modprojectile'],
			                        'npc': ['npc', 'æ•Œæ€ª', 'æ€ª', 'å•†äºº', 'å”®å–', 'å•†åº—'],
			                        'c#': ['c#', 'csharp', '.net', 'è¯­è¨€', 'è¯­æ³•', 'åŸºç¡€'],
			                        'å…¥é—¨': ['å…¥é—¨', 'ä»é›¶', 'å­¦ä¹ è·¯çº¿', 'å‰è¨€', 'modderå…¥é—¨'],
			                        'åŸç†': ['åŸç†', 'æœºåˆ¶', 'æ¦‚å¿µ', 'æµç¨‹', 'ç”Ÿå‘½å‘¨æœŸ', 'æœ¬è´¨', 'åŒºåˆ«']
			                    };
			                    for (const k of Object.keys(table)) {
			                        if (t.includes(k)) return table[k].map(x => x.toLowerCase());
			                    }
			                    return [t];
			                };

			                const hardHints = [];
			                if (routing && Array.isArray(routing.entities)) {
			                    const ents = new Set(routing.entities);
			                    if (ents.has('item')) hardHints.push('ç‰©å“');
			                    if (ents.has('weapon')) hardHints.push('æ­¦å™¨');
			                    if (ents.has('projectile')) hardHints.push('å¼¹å¹•');
			                    if (ents.has('npc')) hardHints.push('npc');
			                    if (ents.has('csharp')) hardHints.push('c#');
			                }
			                if (intent === 'intro') hardHints.push('å…¥é—¨');
			                if (conceptMode) hardHints.push('åŸç†');

			                const expandedHard = [];
			                for (const h of hardHints) for (const s of expandSyn(h)) expandedHard.push(s);

			                const applyRoutingMultipliers = (item, baseScore) => {
			                    let s = baseScore;
			                    if (!routing) return s;
			                    const cat = item.category || '';
			                    if (routing.categoryMultiplier && routing.categoryMultiplier[cat]) {
			                        s *= routing.categoryMultiplier[cat];
			                    }
			                    if (routing.pathMultiplier && routing.pathMultiplier.length) {
			                        const pathHay = `${item.path || ''} ${(item.title || '')}`;
			                        for (const rule of routing.pathMultiplier) {
			                            if (rule && rule.pattern && rule.pattern.test(pathHay)) s *= (rule.mult || 1);
			                        }
			                    }
			                    return s;
			                };

			                const normalizeByMax = (arr, key) => {
			                    let m = 0;
			                    for (const x of arr) m = Math.max(m, Number(x && x[key] ? x[key] : 0) || 0);
			                    if (!m) m = 1;
			                    return m;
			                };

			                const buildKey = (it) => `${it.path || ''}\n${it.text || ''}`;

			                const bm25Max = normalizeByMax(candidates, 'score');

			                let semHits = [];
			                if (semanticOn) {
			                    const sem = await this.loadGuidedSemanticEngine();
			                    if (token !== this.guidedUpdateToken) return;
			                    if (sem && typeof sem.search === 'function') {
			                        try {
			                            semHits = sem.search(this.currentQuery, {
			                                limit: 24,
			                                candidateLimit: 900,
			                                semanticWeight: 0.82,
			                                blockedDocs: this.blockedDocs
			                            });
			                        } catch (error) {
			                            console.warn('è½»é‡è¯­ä¹‰æ£€ç´¢å¤±è´¥:', error);
			                            semHits = [];
			                        }
			                    }
			                }

			                const semMax = normalizeByMax(semHits, 'score');

			                const merged = new Map();
			                for (const it of candidates) {
			                    if (!it) continue;
			                    const k = buildKey(it);
			                    merged.set(k, { item: it, bm25: (Number(it.score) || 0) / bm25Max, sem: 0 });
			                }
			                for (const it of semHits) {
			                    if (!it) continue;
			                    const k = buildKey(it);
			                    const semScore = (Number(it.score) || 0) / semMax;
			                    if (merged.has(k)) {
			                        merged.get(k).sem = Math.max(merged.get(k).sem, semScore);
			                        continue;
			                    }
			                    merged.set(k, { item: it, bm25: 0, sem: semScore });
			                }

			                let guided = Array.from(merged.values()).map(({ item, bm25, sem }) => {
			                    const combined = applyRoutingMultipliers(item, (weightLexical * bm25) + (weightSemantic * sem));
			                    const titleLower = String(item.title || '').toLowerCase();
			                    const textLower = String(item.text || '').toLowerCase();
			                    const hay = titleLower + '\n' + textLower;

			                    let hardHit = 0;
			                    if (expandedHard.length) {
			                        for (const t of expandedHard) {
			                            if (!t || t.length < 2) continue;
			                            if (hay.includes(t)) {
			                                hardHit = 1;
			                                break;
			                            }
			                        }
			                    }

			                    const hardRequired = expandedHard.length > 0;
			                    const gated = hardRequired && hardHit === 0 ? combined * 0.08 : combined;
		                    return { ...item, score: gated, __bm25: bm25, __sem: sem, __hardHit: hardHit, __intent: intent };
		                });
			                guided.sort((a, b) => (b.score || 0) - (a.score || 0));

			                // æ–‡æ¡£å¤šæ ·æ€§ï¼šå…ˆé€‰ top æ–‡æ¡£ï¼Œå†å–æ®µè½
			                const docLimit = 12;
			                const maxPerDoc = 3;
			                const docScore = new Map();
			                for (const g of guided.slice(0, 200)) {
			                    const p = g.path || '';
			                    if (!p) continue;
			                    const prev = docScore.get(p) || 0;
			                    docScore.set(p, Math.max(prev, Number(g.score) || 0));
			                }
			                const topDocs = Array.from(docScore.entries()).sort((a, b) => b[1] - a[1]).slice(0, docLimit).map(([p]) => p);
			                const allowed = new Set(topDocs);
			                const perDoc = new Map();
			                const diversified = [];
			                for (const g of guided) {
			                    const p = g.path || '';
			                    if (!allowed.has(p)) continue;
			                    const c = perDoc.get(p) || 0;
			                    if (c >= maxPerDoc) continue;
			                    perDoc.set(p, c + 1);
			                    diversified.push(g);
			                    if (diversified.length >= 12) break;
			                }
			                guided = diversified;

		                if (token !== this.guidedUpdateToken) return;

		                if (this.blockedDocs && this.blockedDocs.size > 0) {
		                    guided = (guided || []).filter(x => x && x.path && !this.blockedDocs.has(x.path));
		                }

		                if (!guided.length) {
		                    container.style.display = 'none';
		                    list.innerHTML = '';
		                    if (dialog) dialog.style.display = 'none';
		                    if (dialogBody) dialogBody.innerHTML = '';
		                    return;
		                }

		                const guidedForDialog = guided.slice(0, 12);
		                const guidedForList = guided.slice(0, 8);
	
	                const esc = (window.SiteUtils && typeof window.SiteUtils.escapeHtml === 'function')
	                    ? window.SiteUtils.escapeHtml
	                    : (v) => String(v).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s]));
	
	                const viewerBase = this.getViewerBase();
	
	                // å¯¹è¯æ¨¡æ¿ï¼ˆä¸¥æ ¼åŸºäºå¼•ç”¨å†…å®¹ï¼Œä¸ç”Ÿæˆæ— å‡ºå¤„ç»“è®ºï¼‰
	                const uniqueDocs = [];
	                const seenDocPath = new Set();
	                for (const item of guidedForDialog) {
	                    if (!item || !item.path) continue;
	                    if (seenDocPath.has(item.path)) continue;
	                    seenDocPath.add(item.path);
	                    uniqueDocs.push(item);
	                    if (uniqueDocs.length >= 5) break;
	                }
	
	                const renderDialog = (mode) => {
	                    if (!dialog || !dialogBody) return;
	                    const m = mode || 'concise';
	
	                    const hash32 = (str) => {
	                        let h = 0x811c9dc5;
	                        const s = String(str || '');
	                        for (let i = 0; i < s.length; i++) {
	                            h ^= s.charCodeAt(i);
	                            h = Math.imul(h, 0x01000193);
	                        }
	                        return h >>> 0;
	                    };
	                    const pick = (arr, key) => {
	                        if (!arr || arr.length === 0) return '';
	                        return arr[hash32(key) % arr.length];
	                    };
	
	                    const routing = (this.guidedEngine && typeof this.guidedEngine.classifyQuery === 'function')
	                        ? this.guidedEngine.classifyQuery(this.currentQuery)
	                        : null;
	                    const intent = (routing && routing.intent)
	                        ? routing.intent
	                        : ((guidedForDialog[0] && guidedForDialog[0].__intent) ? guidedForDialog[0].__intent : 'unknown');
	
	                    const introLeads = [
	                        'æ…¢æ…¢æ¥å®Œå…¨æ²¡å…³ç³»ã€‚æˆ‘ä»¬å…ˆæŠŠâ€œä»å“ªé‡Œå¼€å§‹ã€å…ˆå­¦ä»€ä¹ˆâ€è¿™ä»¶äº‹ç†é¡ºã€‚',
	                        'ä½ å·²ç»åœ¨åšæœ€å…³é”®çš„ä¸€æ­¥äº†ï¼šæŠŠé—®é¢˜è¯´å‡ºæ¥ã€‚æˆ‘ä»¬å…ˆç”¨ç«™å†…æ–‡ç« æŠŠè·¯çº¿è·‘é€šã€‚',
	                        'å…¥é—¨é˜¶æ®µæœ€æ€•ä¿¡æ¯å¤ªæ•£ã€‚å…ˆæŒ‰ä¸€æ¡ä¸»çº¿èµ°ï¼Œåé¢å†è¡¥ç»†èŠ‚ã€‚'
	                    ];
	                    const howtoLeads = [
	                        'æˆ‘ä»¬å°½é‡èµ°æœ€çŸ­è·¯å¾„ï¼šå…ˆæ‰¾ä¸€ä¸ªâ€œèƒ½ç…§ç€åšâ€çš„æœ€å°ç¤ºä¾‹ã€‚',
	                        'æˆ‘å…ˆæŠŠç«™å†…æœ€ç›¸å…³çš„å¯æ“ä½œæ®µè½ç»™ä½ æŒ‘å‡ºæ¥ï¼Œä½ ç‚¹å¼€å°±èƒ½çœ‹ä¸Šä¸‹æ–‡ã€‚',
	                        'åˆ«æ€¥ç€ä¸€æ¬¡åšå¾ˆå¤æ‚çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å…ˆæŠŠæ ¸å¿ƒæ­¥éª¤è½åœ°ã€‚'
	                    ];
	                    const troubleLeads = [
	                        'è¿™ç§é—®é¢˜é€šå¸¸èƒ½å®šä½åˆ°ä¸€ä¸ªå…·ä½“ç¯èŠ‚ã€‚æˆ‘ä»¬å…ˆç”¨ç«™å†…çº¿ç´¢æŠŠèŒƒå›´ç¼©å°ã€‚',
	                        'å…ˆç¨³ä½ï¼šä»ç°è±¡å…¥æ‰‹ï¼ŒæŒ‰é¡ºåºæ’æŸ¥ã€‚ä¸‹é¢è¿™äº›å¼•ç”¨æ®µè½å¯èƒ½ä¼šå¯¹ä¸Šä½ çš„ç—‡çŠ¶ã€‚',
	                        'æ’é”™æ—¶æœ€é‡è¦çš„æ˜¯å¤ç°è·¯å¾„å’Œå…³é”®æ¡ä»¶ã€‚å…ˆçœ‹è¿™äº›çº¿ç´¢èƒ½ä¸èƒ½å¯¹ä¸Šã€‚'
	                    ];
	
	                    const lead = (intent === 'intro')
	                        ? pick(introLeads, this.currentQuery + '|intro|' + m)
	                        : (intent === 'troubleshoot')
	                            ? pick(troubleLeads, this.currentQuery + '|trouble|' + m)
	                            : pick(howtoLeads, this.currentQuery + '|howto|' + m);
	
	                    const docLinks = uniqueDocs.map((d, idx) => {
	                        const u = `${viewerBase}?file=${encodeURIComponent(d.path)}`;
	                        const t = esc(d.title || d.path || `æ–‡æ¡£ ${idx + 1}`);
	                        return `<a href="${u}">ã€Š${t}ã€‹</a>`;
	                    });
	
	                    const quoteCards = guidedForDialog.slice(0, 4).map(item => {
	                        const u = `${viewerBase}?file=${encodeURIComponent(item.path)}`;
	                        const t = esc(item.title || item.path || 'æ¥æºæ–‡ç« ');
	                        const q = this.highlightText(esc(item.text || ''), this.currentQuery);
	                        const docPathAttr = encodeURIComponent(item.path || '');
	                        return `
	                            <div class="expand-card" data-expanded="false" data-doc-path="${docPathAttr}">
	                                <div class="expand-card-header">
	                                    <div class="expand-card-title">æ¥è‡ª <a href="${u}">ã€Š${t}ã€‹</a></div>
	                                    <div style="display: flex; gap: 8px; align-items: center;">
	                                        <button type="button" class="mismatch-toggle" title="å±è”½è¿™ç¯‡æ–‡ç« ï¼ˆæœ¬æ¬¡ä¼šè¯ï¼‰">ä¸é¢„æœŸä¸ç¬¦</button>
	                                        <button type="button" class="expand-toggle" aria-expanded="false">å±•å¼€</button>
	                                    </div>
	                                </div>
	                                <div class="expand-card-body">${q}</div>
	                            </div>
	                        `;
	                    }).join('');
	
	                    // æ¨èæ–‡ç« å¡ç‰‡ï¼ˆæ¯ç¯‡å–ä¸€ä¸ªæœ€ç›¸å…³æ®µè½ä½œä¸ºå¯å±•å¼€å†…å®¹ï¼‰
	                    const firstQuoteByDoc = new Map();
	                    for (const item of guidedForDialog) {
	                        if (!item || !item.path) continue;
	                        if (firstQuoteByDoc.has(item.path)) continue;
	                        firstQuoteByDoc.set(item.path, item);
	                    }
	
	                    const docCards = uniqueDocs.map((d) => {
	                        const u = `${viewerBase}?file=${encodeURIComponent(d.path)}`;
	                        const t = esc(d.title || d.path || 'æ¥æºæ–‡ç« ');
	                        const q = firstQuoteByDoc.get(d.path);
	                        const metaParts = [];
	                        if (d.category) metaParts.push(esc(this.getCategoryText(d.category)));
	                        if (d.difficulty) metaParts.push(esc(this.getDifficultyText(d.difficulty)));
	                        if (d.last_updated) metaParts.push('æ›´æ–°: ' + esc(d.last_updated));
	                        const docPathAttr = encodeURIComponent(d.path || '');
	                        return `
	                            <div class="expand-card" data-expanded="false" data-doc-path="${docPathAttr}">
	                                <div class="expand-card-header">
	                                    <div class="expand-card-title"><a href="${u}">ã€Š${t}ã€‹</a></div>
	                                    <div style="display: flex; gap: 8px; align-items: center;">
	                                        <button type="button" class="mismatch-toggle" title="å±è”½è¿™ç¯‡æ–‡ç« ï¼ˆæœ¬æ¬¡ä¼šè¯ï¼‰">ä¸é¢„æœŸä¸ç¬¦</button>
	                                        <button type="button" class="expand-toggle" aria-expanded="false">å±•å¼€</button>
	                                    </div>
	                                </div>
	                                ${metaParts.length ? `<div class="expand-card-meta">${metaParts.join(' Â· ')}</div>` : ''}
	                                <div class="expand-card-body">${q ? this.highlightText(esc(q.text || ''), this.currentQuery) : ''}</div>
	                            </div>
	                        `;
	                    }).join('');
	
	                    if (m === 'path') {
	                        dialogBody.innerHTML = `
	                            <div style="margin-bottom: 10px;">${lead}</div>
	                            <div style="margin-bottom: 10px;">ä½ å¯ä»¥å…ˆä»è¿™äº›æ–‡ç« å¼€å§‹é˜…è¯»ï¼ˆæŒ‰ç›¸å…³åº¦æ¨èï¼‰ï¼š${docLinks.slice(0, 3).join(' â†’ ') || 'ï¼ˆæš‚æ— ï¼‰'}ã€‚</div>
	                            <div class="expand-card-meta" style="margin-bottom: 10px;">ç‚¹å‡»æ ‡é¢˜çœ‹å…¨æ–‡ï¼›ç‚¹å‡»â€œå±•å¼€â€æŸ¥çœ‹è¯¥æ–‡æœ€ç›¸å…³çš„å¼•ç”¨æ®µè½ã€‚</div>
	                            ${docCards}
	                        `;
	                        dialog.style.display = 'block';
	                        return;
	                    }
	
	                    if (m === 'clarify') {
	                        const intent = (guidedForDialog[0] && guidedForDialog[0].__intent) ? guidedForDialog[0].__intent : 'unknown';
	                        const suggest = (intent === 'intro')
	                            ? 'ä½ æ›´æƒ³çœ‹ã€Œå…¥é—¨è·¯çº¿ã€è¿˜æ˜¯ã€Œéœ€è¦å…ˆè¡¥çš„åŸºç¡€ï¼ˆC# / tMLï¼‰ã€ï¼Ÿ'
	                            : 'ä½ æ›´åå‘ã€Œå…·ä½“å®ç°æ­¥éª¤ã€è¿˜æ˜¯ã€Œå…ˆçœ‹ä¸€ç¯‡æ¦‚è§ˆ/æœ€å°ç¤ºä¾‹ã€ï¼Ÿ';
	                        dialogBody.innerHTML = `
	                            <div style="margin-bottom: 8px;">${lead}</div>
	                            <div>ä¸ºäº†æ›´å‡†ç¡®åœ°ç»™ä½ å®šä½â€œå¯ç›´æ¥ç…§åšçš„æ•™ç¨‹æ®µè½â€ï¼Œæˆ‘éœ€è¦ç¡®è®¤ä¸€ä¸ªç‚¹ï¼š${suggest}</div>
	                            <div class="expand-card-meta" style="margin-top: 8px; margin-bottom: 10px;">æˆ‘å…ˆæŠŠç«™å†…æœ€ç›¸å…³çš„å¼•ç”¨çº¿ç´¢è´´å‡ºæ¥ï¼ˆç‚¹å‡»æ ‡é¢˜å¯è·³è½¬å…¨æ–‡ï¼‰ï¼š</div>
	                            ${quoteCards}
	                        `;
	                        dialog.style.display = 'block';
	                        return;
	                    }
	
	                    dialogBody.innerHTML = `
	                        <div style="margin-bottom: 10px;">${lead}</div>
	                        <div>æˆ‘åœ¨ç«™å†…æ–‡ç« ä¸­æ‰¾åˆ°äº†è¿™äº›å¯èƒ½ç›¸å…³çš„åŸæ–‡çº¿ç´¢ï¼ˆç‚¹å‡»æ ‡é¢˜æŸ¥çœ‹ä¸Šä¸‹æ–‡ï¼‰ï¼š</div>
	                        <div style="margin-top: 10px;">${quoteCards}</div>
	                    `;
	                    dialog.style.display = 'block';
	                };
	
	                if (dialogMode && !dialogMode.__guidedBound) {
	                    dialogMode.__guidedBound = true;
	                    dialogMode.addEventListener('change', () => {
	                        dialogMode.__userTouched = true;
	                        renderDialog(dialogMode.value);
	                    });
	                }
	
	                // æ ¹æ® intent è‡ªåŠ¨é€‰æ‹©æ¨¡æ¿ï¼ˆç”¨æˆ·æ‰‹åŠ¨åˆ‡æ¢åä¸å†è¦†ç›–ï¼‰
	                if (dialogMode && !dialogMode.__userTouched && this.guidedEngine && typeof this.guidedEngine.classifyQuery === 'function') {
	                    const routing = this.guidedEngine.classifyQuery(this.currentQuery);
	                    const prefer = routing && routing.preferredTemplate ? routing.preferredTemplate : 'concise';
	                    if (dialogMode.value !== prefer) dialogMode.value = prefer;
	                }
	
	                renderDialog(dialogMode ? dialogMode.value : 'concise');
	
	                list.innerHTML = guidedForList.map(item => {
	                    const url = `${viewerBase}?file=${encodeURIComponent(item.path)}`;
	                    const safeText = this.highlightText(esc(item.text || ''), this.currentQuery);
	                    const safeTitle = esc(item.title || item.path || 'æ¥æºæ–‡ç« ');
	                    const metaParts = [];
	                    if (item.category) metaParts.push(esc(this.getCategoryText(item.category)));
	                    if (item.difficulty) metaParts.push(esc(this.getDifficultyText(item.difficulty)));
	                    if (item.last_updated) metaParts.push('æ›´æ–°: ' + esc(item.last_updated));
	                    const docPathAttr = encodeURIComponent(item.path || '');
	                    return `
	                        <div class="guided-answer-item expand-card" data-expanded="false" data-doc-path="${docPathAttr}">
	                            <div class="guided-answer-meta expand-card-header">
	                                <span class="guided-answer-source expand-card-title"><a href="${url}">${safeTitle}</a></span>
	                                <div style="display: flex; gap: 8px; align-items: center;">
	                                    <button type="button" class="mismatch-toggle" title="å±è”½è¿™ç¯‡æ–‡ç« ï¼ˆæœ¬æ¬¡ä¼šè¯ï¼‰">ä¸é¢„æœŸä¸ç¬¦</button>
	                                    <button type="button" class="expand-toggle" aria-expanded="false">å±•å¼€</button>
	                                </div>
	                            </div>
	                            ${metaParts.length ? `<div class="expand-card-meta">${metaParts.join(' Â· ')}</div>` : ''}
	                            <div class="guided-answer-snippet expand-card-body">${safeText}</div>
	                        </div>
	                    `;
	                }).join('');
	
	                container.style.display = 'block';
	            }

            // æ˜¾ç¤ºæœç´¢ç»“æœ
            displaySearchResults() {
                const resultsContainer = document.getElementById('search-results-container');
                const statsContainer = document.getElementById('search-results-stats');
                const noResultsContainer = document.getElementById('no-search-results');
                const resultsCount = document.getElementById('results-count');

                // éšè—æ‰€æœ‰ç»“æœå®¹å™¨
                resultsContainer.style.display = 'none';
                statsContainer.style.display = 'none';
                noResultsContainer.style.display = 'none';

                if (this.searchResults.length === 0) {
                    // æ˜¾ç¤ºæ— ç»“æœæç¤º
                    noResultsContainer.style.display = 'block';
                } else {
                    // æ˜¾ç¤ºç»“æœç»Ÿè®¡
                    resultsCount.textContent = this.searchResults.length;
                    statsContainer.style.display = 'flex';

                    // æ˜¾ç¤ºæœç´¢ç»“æœ
                    resultsContainer.innerHTML = this.searchResults.map(result =>
                        this.createResultItem(result)
                    ).join('');
                    resultsContainer.style.display = 'block';

                    // ç»‘å®šç»“æœé¡¹ç‚¹å‡»äº‹ä»¶
                    resultsContainer.querySelectorAll('.search-result-item-page').forEach((item, index) => {
                        item.addEventListener('click', () => {
                            window.location.href = this.searchResults[index].url;
                        });
                    });
                }
            }

            // åˆ›å»ºæœç´¢ç»“æœé¡¹
            createResultItem(result) {
                const highlightedTitle = this.highlightText(result.title || '', this.currentQuery);
                const highlightedDescription = this.highlightText(result.description || '', this.currentQuery);
                const docPathAttr = encodeURIComponent(result.path || '');

                return `
                    <div class="search-result-item-page expand-card" data-expanded="false" data-doc-path="${docPathAttr}">
                        <div class="expand-card-header" style="margin-bottom: 8px;">
                            <h3 class="search-result-title-page expand-card-title" style="margin: 0;">${highlightedTitle}</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button type="button" class="mismatch-toggle" title="å±è”½è¿™ç¯‡æ–‡ç« ï¼ˆæœ¬æ¬¡ä¼šè¯ï¼‰">ä¸é¢„æœŸä¸ç¬¦</button>
                                <button type="button" class="expand-toggle" aria-expanded="false">å±•å¼€</button>
                            </div>
                        </div>
                        <div class="expand-card-body">
                            <p class="search-result-description-page" style="margin: 0 0 10px 0;">${highlightedDescription}</p>
                            ${result.snippet ? `<p class="search-result-snippet" style="margin: 0;">${result.snippet}</p>` : ''}
                        </div>
                        <div class="search-result-meta-page">
                            <span class="search-result-badge search-result-score">ç›¸å…³æ€§: ${Math.round(result.score || 0)}</span>
                            <span class="search-result-badge">${this.getCategoryText(result.category || '')}</span>
                            <span class="search-result-badge ${result.difficulty}">${this.getDifficultyText(result.difficulty || '')}</span>
                            <span class="search-result-badge">${result.time || 'æœªçŸ¥'}åˆ†é’Ÿ</span>
                        </div>
                    </div>
                `;
            }

            // é«˜äº®æ–‡æœ¬
            highlightText(text, query) {
                if (!query || !text) return text || '';

                // åˆ›å»ºæ­£åˆ™è¡¨è¾¾å¼ï¼Œå¿½ç•¥å¤§å°å†™
                const regex = new RegExp(`(${this.escapeRegex(query)})`, 'gi');
                return text.replace(regex, '<mark>$1</mark>');
            }

            // è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
            escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // æ’åºæœç´¢ç»“æœ
            sortSearchResults(sortBy) {
                switch (sortBy) {
                    case 'title':
                        this.searchResults.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'date':
                        this.searchResults.sort((a, b) => new Date(b.date) - new Date(a.date));
                        break;
                    case 'difficulty':
                        const difficultyOrder = { 'beginner': 1, 'intermediate': 2, 'advanced': 3 };
                        this.searchResults.sort((a, b) =>
                            (difficultyOrder[a.difficulty] || 999) - (difficultyOrder[b.difficulty] || 999)
                        );
                        break;
                    case 'relevance':
                    default:
                        this.searchResults.sort((a, b) => b.score - a.score);
                        break;
                }

                this.displaySearchResults();
            }

	            // åŠ è½½æœç´¢å†å²
	            loadSearchHistory() {
	                const history = localStorage.getItem('searchHistory');
	                return history ? JSON.parse(history) : [];
            }

            // ä¿å­˜æœç´¢å†å²
            saveSearchHistory() {
                localStorage.setItem('searchHistory', JSON.stringify(this.searchHistory));
            }

            // æ·»åŠ åˆ°æœç´¢å†å²
            addToSearchHistory(query) {
                // ç§»é™¤é‡å¤é¡¹
                this.searchHistory = this.searchHistory.filter(item => item !== query);

                // æ·»åŠ åˆ°å¼€å¤´
                this.searchHistory.unshift(query);

                // é™åˆ¶å†å²è®°å½•æ•°é‡
                if (this.searchHistory.length > 10) {
                    this.searchHistory = this.searchHistory.slice(0, 10);
                }

                // ä¿å­˜
                this.saveSearchHistory();

                // æ›´æ–°æ˜¾ç¤º
                this.displaySearchHistory();
            }

            // æ¸…é™¤æœç´¢å†å²
            clearSearchHistory() {
                this.searchHistory = [];
                this.saveSearchHistory();
                this.displaySearchHistory();
            }

            // æ˜¾ç¤ºæœç´¢å†å²
            displaySearchHistory() {
                const historyContainer = document.getElementById('search-history-list');
                const historySection = document.getElementById('search-history-container');

                if (this.searchHistory.length === 0) {
                    historySection.style.display = 'none';
                    return;
                }

                historySection.style.display = 'block';
                historyContainer.innerHTML = this.searchHistory.map(query => `
                    <div class="search-history-item" data-query="${query}">
                        <span>${query}</span>
                        <span class="remove">Ã—</span>
                    </div>
                `).join('');

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                historyContainer.querySelectorAll('.search-history-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (e.target.classList.contains('remove')) {
                            // ç§»é™¤å†å²é¡¹
                            const query = item.dataset.query;
                            this.searchHistory = this.searchHistory.filter(h => h !== query);
                            this.saveSearchHistory();
                            this.displaySearchHistory();
                        } else {
                            // æ‰§è¡Œæœç´¢
                            const query = item.dataset.query;
                            document.getElementById('advanced-search-input').value = query;
                            this.currentQuery = query;
                            this.performSearch();
                        }
                    });
                });
            }

            // è·å–ç±»åˆ«æ–‡æœ¬
            getCategoryText(category) {
                const categories = {
                    '01-å…¥é—¨æŒ‡å—': 'å…¥é—¨æŒ‡å—',
                    '02-åŸºç¡€æ¦‚å¿µ': 'åŸºç¡€æ¦‚å¿µ',
                    '03-å†…å®¹åˆ›å»º': 'å†…å®¹åˆ›å»º',
                    '04-é«˜çº§å¼€å‘': 'é«˜çº§å¼€å‘',
                    '05-ä¸“é¢˜ä¸»é¢˜': 'ä¸“é¢˜ä¸»é¢˜',
                    '06-èµ„æºå‚è€ƒ': 'èµ„æºå‚è€ƒ'
                };
                return categories[category] || category;
            }

            // è·å–éš¾åº¦æ–‡æœ¬
            getDifficultyText(difficulty) {
                const difficulties = {
                    'beginner': 'åˆçº§',
                    'intermediate': 'ä¸­çº§',
                    'advanced': 'é«˜çº§',
                    'åˆçº§': 'åˆçº§',
                    'ä¸­çº§': 'ä¸­çº§',
                    'é«˜çº§': 'é«˜çº§',
                    'å…¨éƒ¨çº§åˆ«': 'å…¨éƒ¨çº§åˆ«'
                };
                return difficulties[difficulty] || difficulty;
            }
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        // åˆå§‹åŒ–æœç´¢ç»“æœé¡µé¢
        document.addEventListener('DOMContentLoaded', function () {
            window.searchResultsPage = new SearchResultsPage();
        });
    </script>
</body>

</html>
